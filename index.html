<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AbsentEase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #283751;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #0c1e01;
            --danger: #f72585;
            --warning: #f8961e;
            --administrator: #9d4edd;
            --admin: #6dd10f;
            --principal: #ee911f;
            --teacher: #ecf000;
            --table: black;
            --border-radius: 12px;
            --box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --greyed-out: #e9ecef;
            --gradient-primary: linear-gradient(120deg, #bccb08 0%, #2d00b7 100%);
            --gradient-secondary: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            --gradient-success: linear-gradient(135deg, #ce0000 0%, #d2aa17 100%);
            --gradient-danger: linear-gradient(135deg, #f72585 0%, #d81b60 100%);
            --gradient-warning: linear-gradient(135deg, #f8961e 0%, #f57c00 100%);
            --gradient-table: linear-gradient(135deg, #0a332269 0%, #0e434f9e 100%);
            --gradient-viewallbtn: linear-gradient(135deg, #0a332269 0%, #0e434f9e 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            background: linear-gradient(135deg, #f5f7fb 0%, #e6e9ff 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--gradient-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #splash-logo {
            width: 140px;
            height: auto;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        

        #message {
            color: white;
            font-size: 1.2rem;
            text-align: center;
            margin-top: 20px;
            font-weight: 300;
        }

        #login-screen, #main-screen, #attendance-screen, #admin-panel {
            display: none;
            padding: 30px 0;
            animation: fadeIn 0.5s ease;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            margin-bottom: 30px;
            padding: 15px 25px;
            background: #410a0a00;

            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border-bottom: 1px solid #e9ecef; 
            gap: 15px; 
        }

        #header-logo, #attendance-header-logo, #admin-header-logo {
            width: auto;
            height: auto;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            align-items: flex-start; 
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
            white-space: nowrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .user-name {
            font-weight: 500;
            color: #000000;
        }
        
        .header-actions {
            display: flex;
            gap: 10px; 
            align-items: center;
        }

        .btn {
            padding: 12px 20px;
            font-size: 1rem;
            min-width: 100px;
            border: none;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            text-decoration: none; 
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            font-size: 1.1rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a56d4 0%, #3630b5 100%);
        }

        .btn-secondary { 
            background: linear-gradient(99deg, #000000cc 0%, #022885 100%);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        }
        
        .btn-logout {
            background-color: #f8f9fa; 
            color: var(--dark); 
            border: 1px solid #dee2e6; 
            padding: 8px 15px; 
            font-size: 0.9rem; 
            font-weight: 500;
            min-width: auto; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }

        .btn-logout:hover {
            background-color: #e9ecef; 
            border-color: #ced4da;
            color: var(--dark);
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.07); 
        }
        
        .btn-logout i {
            font-size: 1rem; 
        }


        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #3ab7d8 0%, #2a9cc4 100%);
        }
        
        .btn-administrator {
            background: linear-gradient(135deg, var(--administrator) 0%, #8c3fd8 100%);
            color: white;
        }
        
        .btn-admin { 
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-principal {
            background: var(--gradient-warning);
            color: white;
        }
        
        .btn-teacher { 
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .role-badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .badge-administrator {
            background: linear-gradient(135deg, var(--administrator) 0%, #8c3fd8 100%);
            color: white;
        }
        
        .badge-admin {
            background: var(--gradient-primary);
            color: white;
        }
        
        .badge-principal {
            background: var(--gradient-warning);
            color: white;
        }
        
        .badge-teacher {
            background: var(--gradient-success);
            color: white;
        }

        .control-panel {
            background: #c0c7cd94;
;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label i {
            font-size: 1.1rem;
            color: var(--primary);
        }

        select, input[type="text"], input[type="password"], input[type="date"], input[type="email"] {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: #f9f9ff;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        select:focus, input[type="text"]:focus, input[type="password"]:focus, 
        input[type="date"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background: white;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .results-container {
            background: #c2e2ff94;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            overflow-x: auto;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 18px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        td .btn-edit-attendance { /* Specific style for edit button in table */
            padding: 5px 10px;
            font-size: 0.8rem;
            min-width: auto;
        }


        th {
            background: var(--gradient-table);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1; /* Ensure header stays above scrolling content */
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .error-message {
            color: var(--danger);
            background: linear-gradient(135deg, rgba(247, 37, 133, 0.1) 0%, rgba(247, 37, 133, 0.05) 100%);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
            border: 1px solid rgba(247, 37, 133, 0.2);
        }

        .success-message {
            color: #2e7d32;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            gap: 5px;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: #555;
            text-align: center; /* Center text in tab */
        }

        .tab:hover {
            background: #f0f2f5;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
            background: rgba(67, 97, 238, 0.05);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .disabled-option {
            background-color: var(--greyed-out);
            color: #6c757d;
            cursor: not-allowed;
        }

        .back-btn { 
            margin-right: 15px; 
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .summary-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .summary-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
            margin: 10px 0;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .summary-card .subtext {
            font-size: 0.95rem;
            color: #6c757d;
        }


        .admin-actions {
            display: flex;
            gap: 10px;
        }

        .admin-actions .btn {
            min-width: auto;
            padding: 8px 15px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title i {
            font-size: 1.3em; /* Make icon slightly larger than text */
        }


        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow form groups to wrap */
        }

        .form-row .form-group {
            flex: 1 1 250px; /* Allow shrinking, basis of 250px, can grow */
            margin-bottom: 0;
        }


        .user-role-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .role-option {
            padding: 10px 20px;
            border-radius: 50px;
            background: #f0f2f5;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .role-option.selected {
            background: var(--gradient-primary);
            color: white;
        }

        .admin-user-list, .activity-log-list, .attendance-management-list { /* Shared style for lists */
            max-height: 400px; /* Or more if needed */
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
        }
        .admin-user-list table, .activity-log-list table, .attendance-management-list table { /* Ensure tables inside these lists are full width */
             width: 100%;
        }


        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
        }
        .admin-user-item:last-child {
            border-bottom: none;
        }


        .admin-user-item:hover {
            background: #f8f9fa;
        }

        .admin-user-info {
            flex: 1;
        }

        .admin-user-email {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .admin-user-role {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .admin-user-class { 
            font-size: 0.85rem;
            color: #888;
            margin-top: 3px;
        }


        .admin-user-actions {
            display: flex;
            gap: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-present {
            background-color: var(--success);
        }

        .status-absent {
            background-color: var(--danger);
        }

        .class-assign-group {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 1050; /* Ensure modal is on top */
            justify-content: center;
            align-items: center;
            animation: fadeInModal 0.3s ease-out;
        }
        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }


        .modal-content {
            background: #cbcf0e4a;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px; /* Default max width */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .modal-content.modal-lg { /* For larger modals if needed */
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem; /* Larger close icon */
            cursor: pointer;
            color: #aaa;
            transition: color 0.2s ease;
        }
        .close-modal:hover {
            color: var(--dark);
        }


        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .modern-login-btn {
          background: linear-gradient(135deg, #4cc9f0, #4361ee);
          color: #fff;
          font-weight: 600;
          letter-spacing: 0.5px;
          padding: 14px 28px;
          font-size: 1rem;
          border-radius: 40px;
          transition: all 0.3s ease;
          box-shadow: 0 6px 14px rgba(67, 97, 238, 0.4);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .modern-login-btn i {
          font-size: 1.2rem;
        }

        .modern-login-btn:hover {
          background: linear-gradient(135deg, #4361ee, #3a56d4);
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(67, 97, 238, 0.5);
        }

        .modern-login-btn:active {
          transform: scale(0.98);
          box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        #global-loader {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255,255,255,0.8);
          display: none; 
          align-items: center;
          justify-content: center;
          z-index: 9999;
        }

        .loader-spinner {
          border: 6px solid #eee;
          border-top: 6px solid var(--primary);
          border-radius: 50%;
          width: 48px;
          height: 48px;
          animation: spin 1s linear infinite;
        }


        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn { 
                width: 90%;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            header { 
                flex-direction: column !important; 
                align-items: center !important; 
                text-align: center !important; 
                gap: 10px; 
            }
            
            #header-logo, #attendance-header-logo, #admin-header-logo {
                margin-bottom: -9px; 
            }

            .header-content {
                align-items: center !important; 
                width: 100% !important;
                text-align: center;
            }

            .app-title {
                flex-direction: column !important; 
                gap: 20px !important;
                align-items: center !important;
            }

            .user-info {
                flex-direction: column !important; 
                align-items: center !important;
                width: 100% !important;
                margin-top: 8px;
            }

            .header-actions {
                flex-direction: column !important; 
                align-items: center !important;
                width: 100% !important;
                gap: 10px !important;
                margin-left: 0 !important; 
                margin-top: 10px; 
            }
            
            .back-btn { 
                margin-right: 0; 
                margin-bottom: 10px; 
            }


            .form-row {
                flex-direction: column;
                gap: 15px;
            }
             .container {
                padding: 0 10px !important;
            }

            select,
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="date"] {
                width: 100% !important;
                box-sizing: border-box;
            }

            .results-container, .admin-user-list, .activity-log-list, .attendance-management-list {
                overflow-x: auto !important;
                padding: 15px !important; 
            }

            table {
                width: 100% !important;
                min-width: unset !important;
                display: block; 
            }

            th, td {
                padding: 10px 12px !important;
                font-size: 0.9rem; 
                text-align: left;
            }
            .tab {
                text-align: center !important;
                width: 100% !important; /* Make tabs full width on mobile */
                font-size: 0.9rem;
                padding: 10px 15px;
                flex-grow: 1; /* Allow tabs to share space if they wrap */
            }
            .modern-login-btn {
                width: 100% !important;
                justify-content: center !important;
            }
            .admin-user-item {
                flex-direction: column !important;
                align-items: flex-start;
                gap: 10px;
            }

            .admin-user-actions {
                width: 100% !important;
                justify-content: flex-start; 
            }
            .admin-user-actions .btn {
                flex-grow: 1; 
            }

            .modal-content {
                width: 95% !important;
            }
            
            .btn#back-btn,
            .btn#admin-back-btn {
                font-size: 0.9rem !important; 
                padding: 8px 15px !important;
                min-width: auto !important;
            }

            .btn#back-btn i,
            .btn#admin-back-btn i {
                font-size: 1rem !important; 
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem !important; 
            }
            
            #header-logo, #attendance-header-logo, #admin-header-logo {
                width: 99px; 
            }
            
            .btn { 
                font-size: 0.9rem !important;
                padding: 8px 15px !important;
            }

            .card-title {
                font-size: 1.3rem !important;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .modal-content-lg {
    max-width: 800px !important;
}
.device-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 15px;
}
.device-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.device-info {
    font-size: 0.9rem;
}
.device-actions {
    margin-top: 5px;
}
/* Add this to your CSS */
.btn-group.center-buttons {
    justify-content: center;
    width: 100%;
}

.btn-group.center-buttons .btn {
    margin: 0 5px;
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/device-detector-js@2.2.10/dist/device-detector.min.js"></script>

</head>
<body>
    <div id="splash-screen">
        <img id="splash-logo" src="https://cdn.imgchest.com/files/yxkcza8jnz7.png" alt="AbsentEase Logo">
        <p id="message"></p>
    </div>
    <div id="global-loader">
      <div class="loader-spinner"></div>
    </div>


    <div id="login-screen">
        <div class="container">
            <div class="control-panel">
                <h2 style="margin-bottom: 25px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-lock"></i> Login to AbsentEase
                </h2>
                <div class="form-group">
                    <label for="email-input"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password-input"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password-input" placeholder="Enter your password">
                </div>
                <div class="btn-group">
                    <button id="login-btn" class="btn btn-primary modern-login-btn">
                      <i class="fas fa-arrow-right-to-bracket"></i>
                      <span>Login</span>
                    </button>
                </div>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <div id="main-screen">
        <div class="container">
            <header>
                <img id="header-logo" src="https://cdn.imgchest.com/files/7mmc9jrkvv7.png" alt="Logo">
                <div class="header-content">
                    <div class="app-title">
                        <h1>  </h1>
                        <span id="user-role-badge" class="role-badge badge-teacher">Teacher</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="user-display-name">John Doe</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="admin-panel-btn" class="btn btn-administrator" style="display: none;">
                        <i class="fas fa-cog"></i> Admin
                    </button>
                    <button id="attendance-btn" class="btn btn-secondary"> 
                        <i class="fas fa-history"></i> Attendance
                    </button>
                    <button id="logout-btn" class="btn btn-logout"> 
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <div class="control-panel">
                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>
                
                <div class="form-group">
                    <label for="class-selector"><i class="fas fa-users"></i> Select Class</label>
                    <select id="class-selector">
                        <!-- Options loaded by JS -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="roll-input"><i class="fas fa-id-card"></i> Enter Roll Numbers</label>
                    <input type="text" id="roll-input" placeholder="Example: 1, 5, 7 or 1 5 7">
                </div>

                <div class="btn-group">
                    <button id="search-btn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button id="view-all-btn" class="btn btn-secondary">
                        <i class="fas fa-list"></i> View All
                    </button>
                    <button id="share-btn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-share-alt"></i> Save & Share
                    </button>
                </div>
            </div>

            <div class="results-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="attendance-screen">
        <div class="container">
            <header>
<button id="attendance-logout-btn" class="btn btn-logout"> 
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                <img id="attendance-header-logo" src="https://cdn.imgchest.com/files/7mmc9jrkvv7.png" alt="Logo">
                <div class="header-content">
                    <div class="app-title">
                        <h1>Attendance Records</h1>
                        <span id="attendance-role-badge" class="role-badge badge-teacher">Teacher</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="attendance-user-name">John Doe</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="admin-panel-btn2" class="btn btn-administrator" style="display: none;">
                        <i class="fas fa-cog"></i> Admin
                    </button>
                    
                <button id="back-btn" class="btn btn-secondary back-btn"> 
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="class">Class Attendance</div>
                <div class="tab" data-tab="individual">Individual Attendance</div>
            </div>

            <div class="tab-content active" id="class-tab">
                <div class="control-panel">
                    <div id="attendance-error" class="error-message"></div>
                    <div id="attendance-success" class="success-message"></div>
                    
                    <div class="form-group">
                        <label for="attendance-class-selector"><i class="fas fa-users"></i> Select Class</label>
                        <select id="attendance-class-selector">
                           <!-- Options loaded by JS -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="date-selector"><i class="fas fa-calendar"></i> Select Date</label>
                        <input type="date" id="date-selector">
                    </div>
                    
                    <div class="btn-group">
                        <button id="load-attendance-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Attendance
                        </button>
                        
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Total Students</h3>
                        <div class="value" id="total-students">0</div>
                        <div class="subtext">in class</div>
                    </div>
                    <div class="summary-card">
                        <h3>Absent Today</h3>
                        <div class="value" id="absent-today">0</div>
                        <div class="subtext">students</div>
                    </div>
                    <div class="summary-card">
                        <h3>Attendance Rate</h3>
                        <div class="value" id="attendance-rate">0%</div>
                        <div class="subtext">for this class</div>
                    </div>
                </div>
                <div class="btn-group center-buttons" style="margin-bottom: 20px;">
    <button id="download-class-attendance-pdf" class="btn btn-success">
        <i class="fas fa-file-pdf"></i> Download PDF
    </button>
</div>

                <div class="results-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Roll No.</th>
                                <th>Student Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body">
                            <tr><td colspan="3" style="text-align: center;">Select a class and date to view attendance</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="individual-tab">
                <div class="control-panel">
                    <div id="individual-error" class="error-message"></div>
                    <div id="individual-success" class="success-message"></div>
                    
                    <div class="form-group">
                        <label for="student-class-selector"><i class="fas fa-users"></i> Select Class</label>
                        <select id="student-class-selector">
                           <!-- Options loaded by JS -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="student-roll-input"><i class="fas fa-id-card"></i> Enter Roll Number</label>
                        <input type="text" id="student-roll-input" placeholder="Enter student roll number">
                    </div>
                    
                    <div class="btn-group">
                        <button id="load-student-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Student Records
                        </button>
                    </div>
                </div>
               <div class="btn-group center-buttons" style="margin-bottom: 20px;">
    <button id="download-individual-attendance-pdf" class="btn btn-success">
        <i class="fas fa-file-pdf"></i> Download PDF
    </button>
</div>

                <div class="results-container">
                    <h3 style="margin-bottom: 15px;">Attendance History for <span id="student-name-display">-</span></h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="student-attendance-body">
                            <tr><td colspan="2" style="text-align: center;">Select a class and student to view records</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <div class="container">
            <header>
                <button id="admin-logout-btn" class="btn btn-logout"> 
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                <img id="admin-header-logo" src="https://cdn.imgchest.com/files/7mmc9jrkvv7.png" alt="Logo">
                <div class="header-content">
                    <div class="app-title">
                        <h1>Admin Panel</h1>
                        <span id="admin-role-badge" class="role-badge badge-administrator">Administrator</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="admin-user-name">Administrator</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    
                    <button id="admin-back-btn" class="btn btn-secondary back-btn"> 
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                    
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="users"><i class="fas fa-users-cog"></i> User Management</div>
                <div class="tab" data-tab="attendance-mgmt"><i class="fas fa-calendar-check"></i> Attendance Management</div>
                <div class="tab" data-tab="activity-logs"><i class="fas fa-history"></i> Activity Logs</div>
                <div class="tab" data-tab="settings"><i class="fas fa-cogs"></i> System Settings</div>
                <div class="tab" data-tab="devices"><i class="fas fa-mobile-alt"></i> Device Management</div>
            </div>

            <!-- User Management Tab -->
            <div class="tab-content active" id="users-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-user-plus"></i> Add New User</h2>
                    <div id="admin-user-error" class="error-message"></div> <!-- Specific error for user add -->
                    <div id="admin-user-success" class="success-message"></div> <!-- Specific success for user add -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-user-email"><i class="fas fa-envelope"></i> Email Address</label>
                            <input type="email" id="new-user-email" placeholder="Enter user email">
                        </div>
                        <div class="form-group">
                            <label for="new-user-password"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="new-user-password" placeholder="Set a password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-user-name"><i class="fas fa-user"></i> Full Name</label>
                            <input type="text" id="new-user-name" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-user-tag"></i> User Role</label>
                            <div class="user-role-select">
                                <div class="role-option" data-role="teacher">Teacher</div>
                                <div class="role-option" data-role="admin">Admin</div>
                                <div class="role-option" data-role="principal">Principal</div>
                                <div class="role-option" data-role="administrator">Administrator</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group class-assign-group" id="class-assign-group">
                        <label for="new-user-class"><i class="fas fa-chalkboard-teacher"></i> Assign Class (for Teachers)</label>
                        <select id="new-user-class">
                           <!-- Options loaded by JS -->
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="add-user-btn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-users"></i> Manage Users</h2>
                    <div class="admin-user-list" id="user-list-table-container">
                        <!-- User table will be loaded here by JS -->
                         <table><thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Class</th><th>Actions</th></tr></thead><tbody id="user-list-tbody"></tbody></table>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="devices-tab">
    <div class="card">
        <h2 class="card-title"><i class="fas fa-cog"></i> Device Settings</h2>
        <div id="device-settings-error" class="error-message"></div>
        <div id="device-settings-success" class="success-message"></div>
        <div class="form-group">
            <label for="max-devices"><i class="fas fa-laptop"></i> Max Devices Per User</label>
            <input type="number" id="max-devices" min="1" max="10" value="3">
        </div>
        <div class="btn-group">
            <button id="save-device-settings-btn" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>
    
    <div class="card">
        <h2 class="card-title"><i class="fas fa-users"></i> User Devices</h2>
        <div class="form-group">
            <label for="device-user-filter"><i class="fas fa-filter"></i> Filter by User</label>
            <input type="text" id="device-user-filter" placeholder="Search by email or name">
        </div>
        <div class="device-list" id="user-devices-list">
            <!-- Devices will be loaded here -->
        </div>
    </div>
</div>


            <!-- Attendance Management Tab -->
            <div class="tab-content" id="attendance-mgmt-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Manage Attendance Records</h2>
                    <div id="mgmt-attendance-error" class="error-message"></div>
                    <div id="mgmt-attendance-success" class="success-message"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mgmt-att-start-date"><i class="fas fa-calendar-day"></i> Start Date</label>
                            <input type="date" id="mgmt-att-start-date">
                        </div>
                        <div class="form-group">
                            <label for="mgmt-att-end-date"><i class="fas fa-calendar-day"></i> End Date</label>
                            <input type="date" id="mgmt-att-end-date">
                        </div>
                        <div class="form-group">
                            <label for="mgmt-att-class-selector"><i class="fas fa-users"></i> Class</label>
                            <select id="mgmt-att-class-selector">
                                <!-- Options loaded by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="load-mgmt-attendance-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Records
                        </button>
                    </div>
                </div>
                <div class="card">
                     <h3 class="card-title" style="font-size: 1.2rem; margin-bottom: 15px;"><i class="fas fa-clipboard-list"></i> Attendance Data</h3>
                    <div class="results-container attendance-management-list">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Roll No.</th>
                                    <th>Student Name</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="mgmt-attendance-table-body">
                                <tr><td colspan="6" style="text-align:center;">Use filters to load attendance records.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="card-title"><i class="fas fa-cog"></i> Attendance Settings</h2>
                     <div id="attendance-settings-error" class="error-message"></div>
                     <div id="attendance-settings-success" class="success-message"></div>
                    <div class="form-group">
                        <label for="attendance-start-date-setting"><i class="fas fa-calendar-alt"></i> Attendance Data Starting Date</label>
                        <input type="date" id="attendance-start-date-setting">
                        <small>This date can be used as a global reference for data queries or retention policies (currently informational).</small>
                    </div>
                    <div class="btn-group">
                        <button id="save-attendance-settings-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Setting
                        </button>
                    </div>
                </div>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-content" id="activity-logs-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-stream"></i> View Activity Logs</h2>
                    <div id="activity-log-error" class="error-message"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="log-start-date"><i class="fas fa-calendar-day"></i> Start Date</label>
                            <input type="date" id="log-start-date">
                        </div>
                        <div class="form-group">
                            <label for="log-end-date"><i class="fas fa-calendar-day"></i> End Date</label>
                            <input type="date" id="log-end-date">
                        </div>
                        <div class="form-group">
                            <label for="log-user-email"><i class="fas fa-user-circle"></i> User Email (Optional)</label>
                            <input type="email" id="log-user-email" placeholder="Filter by user email">
                        </div>
                         <div class="form-group">
                            <label for="log-action-type"><i class="fas fa-tags"></i> Action Type (Optional)</label>
                            <input type="text" id="log-action-type" placeholder="e.g., login, create_user">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="load-activity-logs-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Logs
                        </button>
                    </div>
                </div>
                 <div class="card">
                    <h3 class="card-title" style="font-size: 1.2rem; margin-bottom: 15px;"><i class="fas fa-list-alt"></i> Log Entries</h3>
                    <div class="results-container activity-log-list">
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="activity-logs-table-body">
                               <tr><td colspan="4" style="text-align:center;">Use filters to load activity logs.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- System Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-tools"></i> System Configuration</h2>
                     <div id="system-settings-error" class="error-message"></div>
                     <div id="system-settings-success" class="success-message"></div>
                    <div class="form-group">
                        <label for="system-name"><i class="fas fa-school"></i> School Name</label>
                        <input type="text" id="system-name" placeholder="Enter school name" value="AbsentEase Academy">
                    </div>
                    <div class="form-group">
                        <label for="logo-url"><i class="fas fa-image"></i> Logo URL</label>
                        <input type="text" id="logo-url" placeholder="Enter logo URL" value="https://cdn.imgchest.com/files/7mmc9jrkvv7.png">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bell"></i> Notification Settings</label>
                        <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                                <input type="checkbox" id="email-notifications-setting" checked> Email Notifications
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                                <input type="checkbox" id="inapp-notifications-setting" checked> In-App Notifications
                            </label>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="save-system-settings-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save System Settings
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-shield-alt"></i> Security</h2>
                     <div id="security-settings-error" class="error-message"></div>
                     <div id="security-settings-success" class="success-message"></div>
                    <div class="form-group">
                        <label for="password-policy"><i class="fas fa-key"></i> Password Policy</label>
                        <select id="password-policy">
                            <option value="low">Low (6 characters minimum)</option>
                            <option value="medium" selected>Medium (8 characters with letters and numbers)</option>
                            <option value="high">High (10 characters with letters, numbers and symbols)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="session-timeout"><i class="fas fa-clock"></i> Session Timeout</label>
                        <select id="session-timeout">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="120">2 hours</option>
                            <option value="0">No timeout (Not Recommended)</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="save-security-settings-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Security Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Edit Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h3>
                <button class="close-modal" id="close-edit-user-modal">&times;</button>
            </div>
            <div id="edit-user-error" class="error-message"></div>
            <div id="edit-user-success" class="success-message"></div>
            <div class="form-group">
                <label for="edit-user-name-modal"><i class="fas fa-user"></i> Full Name</label>
                <input type="text" id="edit-user-name-modal" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="edit-user-role-modal"><i class="fas fa-user-tag"></i> User Role</label>
                <select id="edit-user-role-modal">
                    <option value="teacher">Teacher</option>
                    <option value="admin">Admin</option>
                    <option value="principal">Principal</option>
                    <option value="administrator">Administrator</option>
                </select>
            </div>
            <div class="form-group" id="edit-class-assign-group-modal">
                <label for="edit-user-class-modal"><i class="fas fa-chalkboard-teacher"></i> Assign Class</label>
                <select id="edit-user-class-modal">
                   <!-- Options loaded by JS -->
                </select>
            </div>
            <div class="modal-buttons">
                <button id="save-user-changes-btn" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                <button id="cancel-edit-user-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Record Modal -->
    <div id="edit-attendance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-clock"></i> Edit Attendance Status</h3>
                <button class="close-modal" id="close-edit-attendance-modal">&times;</button>
            </div>
            <div id="edit-attendance-error" class="error-message"></div>
            <div id="edit-attendance-success" class="success-message"></div>
            <p>Editing attendance for: <strong id="edit-attendance-student-info"></strong> on <strong id="edit-attendance-date-info"></strong> for Class <strong id="edit-attendance-class-info"></strong>.</p>
            <div class="form-group">
                <label for="edit-attendance-status-select"><i class="fas fa-check-circle"></i> New Status</label>
                <select id="edit-attendance-status-select">
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button id="save-attendance-change-btn" class="btn btn-primary"><i class="fas fa-save"></i> Save Status</button>
                <button id="cancel-edit-attendance-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBBSXXDKjH2kk7c8oaMPEZLDPrbi9L4is4", // Replace with your actual API key if needed
            authDomain: "cvkm-52da0.firebaseapp.com",
            databaseURL: "https://cvkm-52da0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cvkm-52da0",
            storageBucket: "cvkm-52da0.appspot.com", 
            messagingSenderId: "733824760937",
            appId: "1:733824760937:web:5ff6522ac364e55f9d36f8",
            measurementId: "G-R330EPDEMG"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // --- Global Loader Functions ---
        function showLoader() { document.getElementById("global-loader").style.display = "flex"; }
        function hideLoader() { document.getElementById("global-loader").style.display = "none"; }

        // --- User State Variables ---
        let currentUser = null;
        let userRole = 'teacher'; 
        let userDisplayName = 'Guest User'; 
        let userAssignedClass = null; 
        let allClassesData = {}; // Stores class data: { "A1": ["Student1", ...], "B2": [...] }
        let allStudentNames = {}; // Stores { className: { roll: name } } for quick lookup
        let usersLoaded = false; // Flag for admin panel user list

        // --- Centralized Message Display Function ---
        function showMessage(elementId, message, isSuccess = true) {
            const el = document.getElementById(elementId);
            if (!el) {
                console.warn(`showMessage: Element with ID '${elementId}' not found.`);
                return;
            }
            el.textContent = message;
            el.className = isSuccess ? 'success-message' : 'error-message';
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
        
        // --- Activity Logging Function ---
        async function logActivity(action, details = {}) {
            if (!currentUser) {
                console.warn("Attempted to log activity without a current user.", action, details);
                return; 
            }
            const logEntry = {
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: userDisplayName, 
                action: action,
                details: details,
                // Capture device details for the log
                device: details.device || getDeviceDetails(), 
                // Attempt to get IP address (best effort, can be unreliable or blocked)
                ip: await fetch('https://api.ipify.org?format=json').then(res => res.json()).then(data => data.ip).catch(() => 'Unknown')
            };
            try {
                const logRef = database.ref('activityLogs').push(); 
                await logRef.set(logEntry);
            } catch (error) {
                console.error("Error logging activity:", error, logEntry);
            }
        }


        document.addEventListener("DOMContentLoaded", function () {
            // --- DOM Element References ---
            // Screen elements
            const splashScreen = document.getElementById("splash-screen");
            const loginScreen = document.getElementById("login-screen");
            const mainScreen = document.getElementById("main-screen");
            const attendanceScreen = document.getElementById("attendance-screen");
            const adminPanel = document.getElementById("admin-panel");
            const messageEl = document.getElementById("message"); // For splash screen
            
            // Modals
            const editUserModal = document.getElementById("edit-user-modal");
            const editAttendanceModal = document.getElementById("edit-attendance-modal");

            // Login elements
            const loginBtn = document.getElementById("login-btn");
            const emailInput = document.getElementById("email-input");
            const passwordInput = document.getElementById("password-input");
            const loginError = document.getElementById("login-error");
            
            // Logout buttons (ensure all are present in the HTML or check for existence)
            const logoutButtons = [
                document.getElementById("logout-btn"),
                document.getElementById("attendance-logout-btn"),
                document.getElementById("admin-logout-btn")
            ].filter(btn => btn); // Filter out nulls if some buttons don't exist

            // Navigation buttons
            const attendanceBtn = document.getElementById("attendance-btn");
            const backBtn = document.getElementById("back-btn"); // Back from attendance
            const adminBackBtn = document.getElementById("admin-back-btn"); // Back from admin
            const adminPanelBtn = document.getElementById("admin-panel-btn"); // To admin from main
            const adminPanelBtn2 = document.getElementById("admin-panel-btn2"); // To admin from attendance

            // Main screen (absentee sharing) elements
            const mainErrorMessage = document.getElementById("error-message");
            const mainSuccessMessage = document.getElementById("success-message");
            const rollInput = document.getElementById("roll-input");
            const searchBtn = document.getElementById("search-btn");
            const viewAllBtn = document.getElementById("view-all-btn");
            const shareBtn = document.getElementById("share-btn");
            const resultsTableBody = document.getElementById("results-table-body");
            const classSelectorMain = document.getElementById('class-selector');

            // Attendance screen elements
            const attendanceClassSelector = document.getElementById('attendance-class-selector');
            const dateSelectorAttendance = document.getElementById('date-selector');
            const loadAttendanceBtn = document.getElementById('load-attendance-btn');
            const attendanceTableBody = document.getElementById('attendance-table-body');
            const studentClassSelectorIndividual = document.getElementById('student-class-selector');
            const studentRollInputIndividual = document.getElementById('student-roll-input');
            const loadStudentBtnIndividual = document.getElementById('load-student-btn');
            const studentAttendanceBodyIndividual = document.getElementById('student-attendance-body');
            const studentNameDisplayIndividual = document.getElementById('student-name-display');


            // Admin Panel - User Management
            const addUserBtn = document.getElementById("add-user-btn");
            const newUserEmailInput = document.getElementById("new-user-email");
            const newUserPasswordInput = document.getElementById("new-user-password");
            const newUserNameInput = document.getElementById("new-user-name");
            const roleOptionsContainer = document.querySelector(".user-role-select");
            const userListTbody = document.getElementById("user-list-tbody");
            const adminUserError = document.getElementById("admin-user-error");
            const adminUserSuccess = document.getElementById("admin-user-success");
            const classAssignGroupForNewUser = document.getElementById("class-assign-group");
            const newUserClassSelect = document.getElementById("new-user-class");

            // Admin Panel - User Edit Modal elements
            const editUserNameModalInput = document.getElementById("edit-user-name-modal"); 
            const editUserRoleModalSelect = document.getElementById("edit-user-role-modal"); 
            const editUserClassModalSelect = document.getElementById("edit-user-class-modal"); 
            const editClassAssignGroupModal = document.getElementById("edit-class-assign-group-modal");
            const saveUserChangesBtn = document.getElementById("save-user-changes-btn");
            const closeEditUserModalBtn = document.getElementById("close-edit-user-modal");
            const cancelEditUserBtn = document.getElementById("cancel-edit-user-btn");
            const editUserModalError = document.getElementById("edit-user-error");
            const editUserModalSuccess = document.getElementById("edit-user-success");

            // Admin Panel - Attendance Management
            const mgmtAttStartDateInput = document.getElementById('mgmt-att-start-date');
            const mgmtAttEndDateInput = document.getElementById('mgmt-att-end-date');
            const mgmtAttClassSelector = document.getElementById('mgmt-att-class-selector');
            const loadMgmtAttendanceBtn = document.getElementById('load-mgmt-attendance-btn');
            const mgmtAttendanceTableBody = document.getElementById('mgmt-attendance-table-body');
            const attendanceStartDateSettingInput = document.getElementById('attendance-start-date-setting');
            const saveAttendanceSettingsBtn = document.getElementById('save-attendance-settings-btn');
            const mgmtAttendanceError = document.getElementById('mgmt-attendance-error');
            const mgmtAttendanceSuccess = document.getElementById('mgmt-attendance-success');
            const attendanceSettingsError = document.getElementById('attendance-settings-error');
            const attendanceSettingsSuccess = document.getElementById('attendance-settings-success');


            // Admin Panel - Edit Attendance Modal elements
            const editAttendanceStudentInfo = document.getElementById('edit-attendance-student-info');
            const editAttendanceDateInfo = document.getElementById('edit-attendance-date-info');
            const editAttendanceClassInfo = document.getElementById('edit-attendance-class-info');
            const editAttendanceStatusSelect = document.getElementById('edit-attendance-status-select');
            const saveAttendanceChangeBtn = document.getElementById('save-attendance-change-btn');
            const closeEditAttendanceModalBtn = document.getElementById('close-edit-attendance-modal');
            const cancelEditAttendanceBtn = document.getElementById('cancel-edit-attendance-btn');
            const editAttendanceError = document.getElementById('edit-attendance-error');
            const editAttendanceSuccess = document.getElementById('edit-attendance-success');
            let currentEditingAttendanceRecord = null; // To store data for the record being edited


            // Admin Panel - Activity Logs
            const logStartDateInput = document.getElementById('log-start-date');
            const logEndDateInput = document.getElementById('log-end-date');
            const logUserEmailInput = document.getElementById('log-user-email');
            const logActionTypeInput = document.getElementById('log-action-type');
            const loadActivityLogsBtn = document.getElementById('load-activity-logs-btn');
            const activityLogsTableBody = document.getElementById('activity-logs-table-body');
            const activityLogError = document.getElementById('activity-log-error');

            // Admin Panel - System Settings
            const systemNameInput = document.getElementById('system-name');
            const logoUrlInput = document.getElementById('logo-url');
            const emailNotificationsSettingCheckbox = document.getElementById('email-notifications-setting');
            const inAppNotificationsSettingCheckbox = document.getElementById('inapp-notifications-setting');
            const saveSystemSettingsBtn = document.getElementById('save-system-settings-btn');
            const passwordPolicySelect = document.getElementById('password-policy');
            const sessionTimeoutSelect = document.getElementById('session-timeout');
            const saveSecuritySettingsBtn = document.getElementById('save-security-settings-btn');
            const systemSettingsError = document.getElementById('system-settings-error');
            const systemSettingsSuccess = document.getElementById('system-settings-success');
            const securitySettingsError = document.getElementById('security-settings-error');
            const securitySettingsSuccess = document.getElementById('security-settings-success');

            // Admin Panel - Device Management
            const saveDeviceSettingsBtn = document.getElementById('save-device-settings-btn');
            const maxDevicesInput = document.getElementById('max-devices');
            const userDevicesListContainer = document.getElementById('user-devices-list');
            const deviceUserFilterInput = document.getElementById('device-user-filter');


            // --- Firebase Refs and State ---
            let usersDataRef = database.ref('users');
            let currentEditUserUID = null; // For editing user in admin panel

            // --- Welcome Message for Splash Screen ---
            const welcomeMessage = "Welcome To AbsentEase!\nMade By 2023-25 CS Students...";

            // --- Initial Application Setup ---
            async function initializeApp() {
                await loadAllClassesData(); // Load class data (names, rolls)
                populateClassSelectors();   // Populate all <select> elements for classes
                auth.onAuthStateChanged(handleAuthStateChange); // Setup Firebase auth listener
                setupAdminPanelTabs();      // Setup tab navigation for admin panel
                setupAttendanceTabs();      // Setup tab navigation for attendance screen
                setupModalCloseButtons();   // Setup close actions for all modals
                setTodaysDateForDateInputs(); // Set default date for date pickers
                loadSystemSettings();       // Load and apply system-wide settings
                loadAttendanceSettings();   // Load attendance specific settings
                loadDeviceSettings();       // Load device management settings
                setupDeviceManagementListeners(); // Listeners for device management tab
            }

            // --- Data Loading Functions ---
            async function loadAllClassesData() {
                try {
                    const snapshot = await database.ref('classes').once('value');
                    allClassesData = snapshot.val() || {};
                    allStudentNames = {}; // Reset before populating
                    for (const className in allClassesData) {
                        allStudentNames[className] = {};
                        if (Array.isArray(allClassesData[className])) {
                            // Assuming array index is roll number (0-indexed)
                            // And Firebase stores arrays as objects with numeric keys if sparse
                            // If roll numbers are 1-indexed, adjust accordingly
                            allClassesData[className].forEach((name, index) => {
                                const roll = index; // Or index + 1 if 1-indexed
                                if (name && name !== "Coming Soon" && name !== "\"Coming Soon\"") {
                                    allStudentNames[className][roll] = name;
                                }
                            });
                        } else if (typeof allClassesData[className] === 'object' && allClassesData[className] !== null) {
                            // Handle if data is stored as { roll1: name1, roll2: name2 }
                            for(const roll in allClassesData[className]) {
                                const name = allClassesData[className][roll];
                                 if (name && name !== "Coming Soon" && name !== "\"Coming Soon\"") {
                                    allStudentNames[className][roll] = name;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error loading class data:", error);
                    showMessage(mainErrorMessage.id, "Failed to load class data. Some features might not work.", false);
                }
            }
            
            function populateClassSelectors() {
                const classNames = Object.keys(allClassesData).sort(); // Sort class names
                const selectorsToPopulate = [
                    classSelectorMain, attendanceClassSelector, studentClassSelectorIndividual,
                    newUserClassSelect, editUserClassModalSelect, mgmtAttClassSelector
                ];

                selectorsToPopulate.forEach(selector => {
                    if (selector) {
                        selector.innerHTML = ''; // Clear existing options
                        if (classNames.length === 0) {
                            const defaultOption = document.createElement('option');
                            defaultOption.textContent = "No classes available";
                            defaultOption.disabled = true;
                            selector.appendChild(defaultOption);
                        } else {
                             classNames.forEach(clsName => {
                                const option = document.createElement('option');
                                option.value = clsName;
                                option.textContent = `Class ${clsName}`; // Display format
                                selector.appendChild(option);
                            });
                        }
                        // Trigger change for the main class selector to set initial studentsDataRef if applicable
                        if (selector.id === 'class-selector' && classNames.length > 0) {
                             selector.dispatchEvent(new Event('change')); // Ensure initial data ref is set
                        }
                    }
                });
            }
            
            function setTodaysDateForDateInputs() {
                const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
                const dateInputs = [
                    dateSelectorAttendance, mgmtAttStartDateInput, mgmtAttEndDateInput,
                    logStartDateInput, logEndDateInput
                ];
                dateInputs.forEach(input => { if(input) input.value = today; });
            }

            // --- UI Setup Functions (Tabs, Modals) ---
            function setupTabs(tabContainerSelector, activeTabClass = 'active') {
                const tabContainer = document.querySelector(tabContainerSelector);
                if (!tabContainer) return;

                const tabs = tabContainer.querySelectorAll('.tabs .tab');
                const tabContents = tabContainer.querySelectorAll('.tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove(activeTabClass));
                        tabContents.forEach(c => c.classList.remove(activeTabClass));
                        
                        tab.classList.add(activeTabClass);
                        const tabId = tab.getAttribute('data-tab');
                        const activeContent = tabContainer.querySelector(`#${tabId}-tab`);
                        if (activeContent) activeContent.classList.add(activeTabClass);
                        
                        // Log navigation if it's the admin panel
                        if (tabContainerSelector === '#admin-panel') {
                           logActivity('admin_navigate_tab', { tab: tabId });
                        }
                         // If device tab is clicked in admin, load devices
                        if (tabContainerSelector === '#admin-panel' && tabId === 'devices') {
                            loadAndDisplayUserDevices();
                        }
                    });
                });
            }

            function setupAdminPanelTabs() { setupTabs('#admin-panel'); }
            function setupAttendanceTabs() { setupTabs('#attendance-screen'); }
            
            function setupModalCloseButtons() {
                const modals = [
                    { modal: editUserModal, closeBtn: closeEditUserModalBtn, cancelBtn: cancelEditUserBtn },
                    { modal: editAttendanceModal, closeBtn: closeEditAttendanceModalBtn, cancelBtn: cancelEditAttendanceBtn }
                ];

                modals.forEach(item => {
                    if (item.modal) {
                        if(item.closeBtn) item.closeBtn.addEventListener('click', () => item.modal.style.display = 'none');
                        if(item.cancelBtn) item.cancelBtn.addEventListener('click', () => item.modal.style.display = 'none');
                        // Close modal if clicked outside content
                        window.addEventListener('click', (e) => {
                            if (e.target === item.modal) item.modal.style.display = 'none';
                        });
                    }
                });
            }

            // --- Splash Screen Handler ---
            async function handleSplashScreen() {
                if(messageEl) await typeMessage(welcomeMessage, messageEl); // Type out message
                if(splashScreen) {
                    splashScreen.classList.add("fade-out");
                    setTimeout(() => { splashScreen.style.display = "none"; }, 500); // Delay hide for fade effect
                }
            }

            function typeMessage(msg, element) {
                return new Promise(resolve => {
                    let index = 0;
                    element.innerHTML = ''; // Clear previous text
                    function type() {
                        if (index < msg.length) {
                            element.innerHTML += msg[index] === '\n' ? '<br>' : msg[index];
                            index++;
                            setTimeout(type, 50); // Typing speed
                        } else {
                            setTimeout(resolve, 1500); // Pause after typing
                        }
                    }
                    type();
                });
            }

            // --- Auth State and UI Update Functions ---
            function updateUserUIDisplay() {
                const roleBadgeElements = [
                    document.getElementById('user-role-badge'),
                    document.getElementById('attendance-role-badge'),
                    document.getElementById('admin-role-badge')
                ].filter(el => el); // Filter out nulls

                roleBadgeElements.forEach(badge => {
                    badge.className = 'role-badge'; // Reset classes
                    badge.classList.add(`badge-${userRole}`); // Add role-specific class
                    badge.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1); // Capitalize role
                });
                
                // Update display names
                const displayNameElements = [
                    document.getElementById('user-display-name'),
                    document.getElementById('attendance-user-name'),
                    document.getElementById('admin-user-name')
                ].filter(el => el);
                displayNameElements.forEach(el => el.textContent = userDisplayName);
                
                // Show/hide admin panel buttons based on role
                const showAdminAccess = userRole === 'administrator';
                if(adminPanelBtn) adminPanelBtn.style.display = showAdminAccess ? 'inline-flex' : 'none';
                if(adminPanelBtn2) adminPanelBtn2.style.display = showAdminAccess ? 'inline-flex' : 'none';
                
                updateRoleBasedClassSelectors(); // Update class selectors based on role (e.g., teacher's assigned class)
            }
            
            function updateRoleBasedClassSelectors() {
                // Selectors that might be restricted by role (e.g., teacher sees only their class)
                const selectorsForRoleFiltering = [classSelectorMain, attendanceClassSelector, studentClassSelectorIndividual];
                const classNames = Object.keys(allClassesData).sort();

                selectorsForRoleFiltering.forEach(selector => {
                    if (!selector) return;
                    const currentVal = selector.value; // Preserve selection if possible
                    selector.innerHTML = ''; 
                    
                    if (userRole === 'teacher' && userAssignedClass) {
                        if (classNames.includes(userAssignedClass)) {
                            const option = document.createElement('option');
                            option.value = userAssignedClass;
                            option.textContent = `Class ${userAssignedClass}`;
                            selector.appendChild(option);
                        } else {
                            selector.innerHTML = '<option disabled selected>No assigned class found</option>';
                        }
                    } else { // For admins, principals, or if teacher has no specific class assigned
                        if (classNames.length === 0) {
                             selector.innerHTML = '<option disabled selected>No classes available</option>';
                        } else {
                            classNames.forEach(clsName => {
                                const option = document.createElement('option');
                                option.value = clsName;
                                option.textContent = `Class ${clsName}`;
                                selector.appendChild(option);
                            });
                            if (currentVal && classNames.includes(currentVal)) {
                                selector.value = currentVal; 
                            } else if (classNames.length > 0) {
                                selector.value = classNames[0]; // Default to first class if previous selection is invalid
                            }
                        }
                    }
                     // Trigger change event for main class selector to load initial data
                    if (selector.id === 'class-selector') {
                        selector.dispatchEvent(new Event('change'));
                    }
                });
            }

            async function handleAuthStateChange(user) {
                // Ensure splash screen is handled only once on initial load
                if (splashScreen && !splashScreen.classList.contains('fade-out')) {
                    await handleSplashScreen();
                }
                showLoader();
                if (user) {
                    currentUser = user;
                    try {
                        const userRef = database.ref(`users/${user.uid}`);
                        const snapshot = await userRef.once('value');
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            userRole = userData.role || 'teacher'; // Default to teacher if role not set
                            userDisplayName = userData.name || user.email.split('@')[0]; // Fallback name
                            userAssignedClass = userData.class || null;
                            
                            updateUserUIDisplay(); // Update all UI elements related to user info
                            
                            loginScreen.style.display = "none"; // Hide login screen
                            // Handle navigation based on URL hash or default to main screen
                            const currentHash = window.location.hash;
                            if (currentHash === '#admin' && userRole === 'administrator') {
                                adminPanel.style.display = "block";
                                mainScreen.style.display = "none"; attendanceScreen.style.display = "none";
                                loadAndDisplayUserDevices(); // Load devices if landing on admin/devices tab
                            } else if (currentHash === '#attendance') {
                                attendanceScreen.style.display = "block";
                                mainScreen.style.display = "none"; adminPanel.style.display = "none";
                            } else {
                                mainScreen.style.display = "block";
                                attendanceScreen.style.display = "none"; adminPanel.style.display = "none";
                                if (currentHash && currentHash !== '#') window.location.hash = ''; // Clear invalid hash
                            }
                            
                            // Load admin-specific data if user is administrator and data not yet loaded
                            if (userRole === 'administrator' && !usersLoaded) {  
                                loadUsersForAdminTable();
                                usersLoaded = true; // Set flag
                            }
                            // Log successful session start (consider adding a flag to log only on explicit new login vs. refresh)
                            // logActivity('login_session_active', { email: user.email }); 

                        } else {
                            console.error("User data not found in database for UID:", user.uid, ". Logging out.");
                            await logActivity('auth_error', { error: 'User data not found in DB', email: user.email });
                            auth.signOut(); 
                        }
                    } catch (error) {
                        console.error("Error fetching user data:", error);
                        await logActivity('auth_error', { error: 'Failed to fetch user data', message: error.message, email: user.email });
                        auth.signOut(); 
                    }
                } else { // No user logged in
                    currentUser = null; userRole = 'guest'; userDisplayName = 'Guest';
                    // Hide all authenticated screens, show login screen
                    mainScreen.style.display = "none"; attendanceScreen.style.display = "none";
                    adminPanel.style.display = "none"; loginScreen.style.display = "block";
                    usersLoaded = false; // Reset admin data loaded flag
                    if (window.location.hash) window.location.hash = ''; // Clear any navigation hash
                }
                hideLoader(); 
            }
            
            // --- Event Listener for Login Button ---
            if(loginBtn) {
                loginBtn.addEventListener("click", async () => { // Made async for logActivity
                    showLoader();
                    const email = emailInput.value.trim();
                    const password = passwordInput.value;

                    if (!email || !password) {
                        showMessage(loginError.id, "Please fill in both email and password.", false);
                        hideLoader();
                        return;
                    }

                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        // onAuthStateChanged will handle UI updates and further loading.
                        // Log successful login attempt here as onAuthStateChanged might fire on refresh too.
                        await logActivity('login_success', { email: email, device: getDeviceDetails() });
                        loginError.style.display = "none"; // Clear previous errors
                    } catch (error) {
                        showMessage(loginError.id, `<i class="fas fa-exclamation-circle"></i> Login failed: ${error.message}`, false);
                        await logActivity('login_failure', { email: email, error: error.message, device: getDeviceDetails() });
                        hideLoader();
                    }
                });
            }
            
            // --- Event Listener for Logout Buttons ---
            function handleLogoutAction() {
                showLoader();
                const emailBeforeLogout = currentUser ? currentUser.email : 'unknown_user_logging_out';
                auth.signOut()
                    .then(async () => { 
                        // onAuthStateChanged will handle UI changes to show login screen.
                        await logActivity('logout', { email: emailBeforeLogout, device: getDeviceDetails() });
                        // hideLoader() will be called by onAuthStateChanged after it processes the signed-out state.
                    })
                    .catch(async (error) => { 
                        console.error("Logout error:", error);
                        showMessage(loginError.id, `Logout failed: ${error.message}`, false); // Show error on login screen if visible
                        await logActivity('logout_failure', { email: emailBeforeLogout, error: error.message, device: getDeviceDetails() });
                        hideLoader(); // Explicitly hide loader on error here
                    });
            }
            logoutButtons.forEach(btn => { if(btn) btn.addEventListener("click", handleLogoutAction); });
            
            // --- Navigation Event Listeners ---
            if(attendanceBtn) attendanceBtn.addEventListener("click", () => {
                mainScreen.style.display = "none"; attendanceScreen.style.display = "block"; adminPanel.style.display = "none";
                window.location.hash = '#attendance'; // Update hash for deep linking/refresh
                logActivity('navigate', { to: 'attendance_screen' });
            });
            
            if(backBtn) backBtn.addEventListener("click", () => { // Back from attendance to main
                attendanceScreen.style.display = "none"; mainScreen.style.display = "block"; adminPanel.style.display = "none";
                window.location.hash = ''; // Clear hash
                logActivity('navigate', { to: 'main_screen', from: 'attendance_screen' });
            });
            
            if(adminBackBtn) adminBackBtn.addEventListener("click", () => { // Back from admin to main
                adminPanel.style.display = "none"; mainScreen.style.display = "block"; attendanceScreen.style.display = "none";
                window.location.hash = ''; // Clear hash
                logActivity('navigate', { to: 'main_screen', from: 'admin_panel' });
            });
            
            function showAdminPanelScreen() {
                if (userRole !== 'administrator') {
                    showMessage(mainErrorMessage.id, "Access denied. Administrator rights required.", false);
                    return;
                }
                mainScreen.style.display = "none"; attendanceScreen.style.display = "none"; adminPanel.style.display = "block";
                window.location.hash = '#admin'; // Update hash
                logActivity('navigate', { to: 'admin_panel' });
                if (!usersLoaded) { // Load users if not already loaded (e.g., direct navigation via hash)
                    loadUsersForAdminTable();
                    usersLoaded = true;
                }
                // Ensure the first tab in admin panel is active if navigating directly
                const firstAdminTab = document.querySelector('#admin-panel .tabs .tab');
                const firstAdminTabContent = document.querySelector('#admin-panel .tab-content');
                if(firstAdminTab && !firstAdminTab.classList.contains('active')){
                    document.querySelectorAll('#admin-panel .tabs .tab, #admin-panel .tab-content').forEach(el => el.classList.remove('active'));
                    firstAdminTab.classList.add('active');
                    if(firstAdminTabContent) firstAdminTabContent.classList.add('active');
                }

            }
            if(adminPanelBtn) adminPanelBtn.addEventListener("click", showAdminPanelScreen);
            if(adminPanelBtn2) adminPanelBtn2.addEventListener("click", showAdminPanelScreen);

            // --- Main Screen (Absentee Sharing) Logic ---
            let studentsDataRefMain; // Firebase ref for selected class's students
            if(classSelectorMain) {
                classSelectorMain.addEventListener('change', (e) => {
                    const selectedClass = e.target.value;
                    if (selectedClass && allClassesData[selectedClass]) {
                        // This ref might not be needed if allStudentNames is comprehensive
                        // studentsDataRefMain = database.ref(`classes/${selectedClass}`);
                        // Clear previous results when class changes
                        resultsTableBody.innerHTML = '';
                        shareBtn.style.display = 'none';
                        rollInput.value = '';
                    } else {
                        resultsTableBody.innerHTML = '<tr><td colspan="2">Select a valid class.</td></tr>';
                        shareBtn.style.display = 'none';
                    }
                });
            }

            if(searchBtn) searchBtn.addEventListener('click', async () => {
                const selectedClass = classSelectorMain.value;
                if (!selectedClass || !allStudentNames[selectedClass]) {
                    showMessage(mainErrorMessage.id, "Please select a valid class first.", false); return;
                }
                showLoader();
                const rollInputVal = rollInput.value.trim();
                // Allow comma or space as delimiters, remove duplicates, parse to int, filter NaNs
                const rollNumbers = [...new Set(rollInputVal.split(/[,\s]+/).map(num => parseInt(num.trim())).filter(n => !isNaN(n) && n >= 0))];
                
                if (!rollNumbers.length && rollInputVal.length > 0) { // If input was given but parsed to nothing valid
                     showMessage(mainErrorMessage.id, "Please enter valid, non-negative roll numbers.", false); hideLoader(); return;
                }
                if (rollNumbers.length === 0 && rollInputVal.length === 0) { // If input is empty, effectively same as "View All" for this class
                    viewAllBtn.click(); // Programmatically click view all
                    hideLoader();
                    return;
                }

                try {
                    const studentClassData = allStudentNames[selectedClass] || {};
                    const results = rollNumbers.map(roll => ({
                        roll, 
                        name: studentClassData[roll], // Access name using roll as key
                        isValid: studentClassData[roll] // Check if student exists for that roll
                    })).sort((a, b) => a.roll - b.roll) // Sort by roll number
                       .map(item => item.isValid ? `<tr><td>${item.roll}</td><td>${item.name}</td></tr>`
                                                 : `<tr class="error-row"><td>${item.roll}</td><td>Not Found</td></tr>`);
                    
                    resultsTableBody.innerHTML = results.join('') || `<tr><td colspan="2">No students found for the given rolls.</td></tr>`;
                    shareBtn.style.display = results.some(r => !r.includes("Not Found")) ? 'inline-flex' : 'none';
                    await logActivity('search_students', { class: selectedClass, rolls: rollNumbers.join(',') });
                } catch (error) {
                    showMessage(mainErrorMessage.id, `Error fetching student data: ${error.message}`, false);
                    await logActivity('search_students_error', { class: selectedClass, error: error.message });
                }
                hideLoader();
            });
            
            if(viewAllBtn) viewAllBtn.addEventListener('click', async () => {
                const selectedClass = classSelectorMain.value;
                if (!selectedClass || !allStudentNames[selectedClass]) {
                     showMessage(mainErrorMessage.id, "Please select a valid class to view all students.", false); return;
                }
                showLoader();
                const studentsInClass = allStudentNames[selectedClass] || {};
                let resultsHTML = '';
                // Sort by roll number (assuming roll numbers are numeric keys)
                Object.entries(studentsInClass)
                      .sort((a,b) => parseInt(a[0]) - parseInt(b[0])) 
                      .forEach(([roll, name]) => {
                            resultsHTML += `<tr><td>${roll}</td><td>${name}</td></tr>`;
                });

                resultsTableBody.innerHTML = resultsHTML || `<tr><td colspan="2">No students found in this class.</td></tr>`;
                shareBtn.style.display = resultsHTML ? 'inline-flex' : 'none'; // Show share if there are students
                rollInput.value = ''; // Clear roll input when viewing all
                await logActivity('view_all_students', { class: selectedClass });
                hideLoader();
            });

            if(shareBtn) shareBtn.addEventListener('click', async () => {
                showLoader();
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
                const yyyy = today.getFullYear();
                const todayFormatted = `${dd}-${mm}-${yyyy}`; // For display
                const todayDB = `${yyyy}-${mm}-${dd}`; // For database key (YYYY-MM-DD for sorting)
                
                const rows = resultsTableBody.querySelectorAll('tr');
                if (rows.length === 0) {
                    showMessage(mainErrorMessage.id, "No absentees listed to share.", false); hideLoader(); return;
                }
                
                const selectedClass = classSelectorMain.value;
                if (!selectedClass) {
                     showMessage(mainErrorMessage.id, "No class selected for saving attendance.", false); hideLoader(); return;
                }

                const absenteesForDB = []; // For storing in Firebase {roll, name}
                const absenteeNamesForShare = []; // For the text to be shared (names only)

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Ensure it's a valid student row (not "Not Found" or header)
                    if (cells.length === 2 && cells[1].textContent !== "Not Found") {
                        absenteesForDB.push({ roll: cells[0].textContent.trim(), name: cells[1].textContent.trim() });
                        absenteeNamesForShare.push(cells[1].textContent.trim());
                    }
                });
                
                if (absenteesForDB.length === 0) {
                    showMessage(mainErrorMessage.id, "No valid absentees to save or share.", false); hideLoader(); return;
                }

                try {
                    // Save to Firebase
                    const attendanceRef = database.ref(`attendance/${todayDB}/${selectedClass}`);
                    await attendanceRef.set({ 
                        date: todayDB, 
                        class: selectedClass, 
                        absentees: absenteesForDB, 
                        recordedBy: currentUser.uid, 
                        recordedByName: userDisplayName,
                        recordedAt: firebase.database.ServerValue.TIMESTAMP 
                    });
                    showMessage(mainSuccessMessage.id, "Attendance saved successfully!");
                    await logActivity('share_attendance_success', { class: selectedClass, date: todayDB, count: absenteesForDB.length });

                    // Prepare text for sharing (as per new format)
                    let shareText = `Today's Absentees (${todayFormatted})\n---------------------------------------\n`;
                    absenteeNamesForShare.forEach(name => { shareText += `${name}\n`; });

                    // Use Web Share API if available, otherwise fallback to clipboard
                    if (navigator.share) {
                        await navigator.share({ 
                            title: `Absentees - ${todayFormatted}`, // Title for the share dialog
                            text: shareText 
                        });
                    } else {
                        fallbackShareText(shareText, mainSuccessMessage.id, "Absentees list copied to clipboard! (Share API not available)");
                    }
                } catch (error) {
                    showMessage(mainErrorMessage.id, `Error saving or sharing: ${error.message}`, false);
                    await logActivity('share_attendance_error', { class: selectedClass, date: todayDB, error: error.message });
                }
                hideLoader();
            });
            
            // Fallback for sharing if Web Share API is not available
            function fallbackShareText(text, messageElementId, successText) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // Prevent scrolling to bottom of page
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy'); // execCommand is deprecated but widely supported
                    showMessage(messageElementId, successText, true);
                } catch (err) {
                    showMessage(messageElementId, "Could not copy text. Please copy manually.", false);
                    console.error('Fallback copy to clipboard error:', err);
                    // Avoid using alert()
                }
                document.body.removeChild(textarea);
            }
            
            // --- Attendance Screen Logic ---
            if(loadAttendanceBtn) loadAttendanceBtn.addEventListener('click', async () => {
                showLoader();
                const selectedClass = attendanceClassSelector.value;
                const selectedDate = dateSelectorAttendance.value; // Format YYYY-MM-DD
                const errorElId = 'attendance-error'; 
                const successElId = 'attendance-success';
                
                if (!selectedClass || !selectedDate) {
                    showMessage(errorElId, "Please select both class and date.", false); hideLoader(); return;
                }
                
                try {
                    const studentsInClass = allStudentNames[selectedClass] || {};
                    const totalStudentsCount = Object.keys(studentsInClass).length;
                    if(document.getElementById('total-students')) document.getElementById('total-students').textContent = totalStudentsCount;
                    
                    const attendanceRef = database.ref(`attendance/${selectedDate}/${selectedClass}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    const attendanceData = attendanceSnapshot.val();
                    
                    let absentCount = 0;
                    let tableHTML = '';
                    const absentRolls = new Set(attendanceData && attendanceData.absentees ? attendanceData.absentees.map(a => a.roll.toString()) : []);

                    // Iterate over all students in the class, mark absent or present
                    Object.entries(studentsInClass).sort((a,b) => parseInt(a[0]) - parseInt(b[0])).forEach(([roll, name]) => {
                        const isAbsent = absentRolls.has(roll);
                        if (isAbsent) absentCount++;
                        tableHTML += `
                            <tr>
                                <td>${roll}</td><td>${name}</td>
                                <td>${isAbsent ? '<span class="status-indicator status-absent"></span><span style="color: var(--danger);"><i class="fas fa-times"></i> Absent</span>' 
                                              : '<span class="status-indicator status-present"></span><span style="color: var(--success);"><i class="fas fa-check"></i> Present</span>'}</td>
                            </tr>`;
                    });
                    
                    attendanceTableBody.innerHTML = tableHTML || `<tr><td colspan="3" style="text-align:center;">No student data found for this class.</td></tr>`;
                    if(document.getElementById('absent-today')) document.getElementById('absent-today').textContent = absentCount;
                    const attendanceRate = totalStudentsCount > 0 ? Math.round(((totalStudentsCount - absentCount) / totalStudentsCount) * 100) : 0;
                    if(document.getElementById('attendance-rate')) document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
                    
                    showMessage(successElId, `Attendance loaded for Class ${selectedClass} on ${selectedDate}.`);
                    await logActivity('load_class_attendance_view', { class: selectedClass, date: selectedDate });
                } catch (error) {
                    showMessage(errorElId, `Error loading attendance: ${error.message}`, false);
                    await logActivity('load_class_attendance_error', { class: selectedClass, date: selectedDate, error: error.message });
                }
                hideLoader();
            });
            
            if(loadStudentBtnIndividual) loadStudentBtnIndividual.addEventListener('click', async () => {
                showLoader();
                const selectedClass = studentClassSelectorIndividual.value;
                const rollNumber = studentRollInputIndividual.value.trim();
                const errorElId = 'individual-error'; 
                const successElId = 'individual-success';
                
                if (!selectedClass || !rollNumber) {
                    showMessage(errorElId, "Please select a class and enter a roll number.", false); hideLoader(); return;
                }
                
                try {
                    const studentName = (allStudentNames[selectedClass] && allStudentNames[selectedClass][rollNumber]) || "N/A";
                    if (studentName === "N/A") {
                         showMessage(errorElId, `Student with Roll No. ${rollNumber} not found in Class ${selectedClass}.`, false); 
                         studentAttendanceBodyIndividual.innerHTML = `<tr><td colspan="2" style="text-align:center;">Student not found.</td></tr>`;
                         if(studentNameDisplayIndividual) studentNameDisplayIndividual.textContent = '-';
                         hideLoader(); 
                         return;
                    }
                    if(studentNameDisplayIndividual) studentNameDisplayIndividual.textContent = `${studentName} (Roll: ${rollNumber}, Class: ${selectedClass})`;
                    
                    const attendanceRecordsRef = database.ref(`attendance`); 
                    // Fetch all attendance data. For large datasets, this needs optimization (e.g., indexing or restructuring data).
                    const snapshot = await attendanceRecordsRef.orderByKey().once('value'); 
                    const allAttendanceData = snapshot.val();
                    
                    let tableHTML = '';
                    let recordsFoundForStudent = false;
                    if (allAttendanceData) {
                        // Sort dates chronologically (YYYY-MM-DD string sort works here)
                        Object.keys(allAttendanceData).sort().forEach(dateKey => { 
                            // Check if data exists for the specific class on this date
                            if (allAttendanceData[dateKey][selectedClass] && allAttendanceData[dateKey][selectedClass].absentees) {
                                const isAbsent = allAttendanceData[dateKey][selectedClass].absentees.some(a => a.roll.toString() === rollNumber);
                                const [year, month, day] = dateKey.split('-');
                                const formattedDate = `${day}-${month}-${year}`; // DD-MM-YYYY for display
                                tableHTML += `
                                    <tr>
                                        <td>${formattedDate}</td>
                                        <td>${isAbsent ? '<span class="status-indicator status-absent"></span><span style="color: var(--danger);"><i class="fas fa-times"></i> Absent</span>' 
                                                      : '<span class="status-indicator status-present"></span><span style="color: var(--success);"><i class="fas fa-check"></i> Present</span>'}</td>
                                    </tr>`;
                                recordsFoundForStudent = true;
                            }
                        });
                    }
                    studentAttendanceBodyIndividual.innerHTML = tableHTML || `<tr><td colspan="2" style="text-align:center;">No attendance records found for this student.</td></tr>`;
                    if (recordsFoundForStudent) {
                        showMessage(successElId, `Attendance history loaded for ${studentName}.`);
                    } else {
                         showMessage(successElId, `No attendance records found for ${studentName}.`, true); // Still a success in loading, just no data
                    }
                    await logActivity('load_individual_attendance_view', { class: selectedClass, roll: rollNumber });
                } catch (error) {
                    showMessage(errorElId, `Error loading student records: ${error.message}`, false);
                     await logActivity('load_individual_attendance_error', { class: selectedClass, roll: rollNumber, error: error.message });
                }
                hideLoader();
            });

            // --- Admin Panel - User Management ---
            let selectedRoleForNewUser = 'teacher'; // Default role for new user
            if(roleOptionsContainer) {
                const roleOptionDivs = roleOptionsContainer.querySelectorAll(".role-option");
                roleOptionDivs.forEach(option => {
                    option.addEventListener('click', () => {
                        roleOptionDivs.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        selectedRoleForNewUser = option.getAttribute('data-role');
                        // Show/hide class assignment based on role
                        if(classAssignGroupForNewUser) classAssignGroupForNewUser.style.display = selectedRoleForNewUser === 'teacher' ? 'block' : 'none';
                    });
                });
                // Default selection visual state
                const defaultRoleOption = roleOptionsContainer.querySelector('.role-option[data-role="teacher"]');
                if (defaultRoleOption) {
                    defaultRoleOption.classList.add('selected');
                    if(classAssignGroupForNewUser) classAssignGroupForNewUser.style.display = 'block';
                }
            }


            if(addUserBtn) addUserBtn.addEventListener('click', async () => {
                showLoader();
                const email = newUserEmailInput.value.trim();
                const password = newUserPasswordInput.value; // Do not trim password
                const name = newUserNameInput.value.trim();
                const classAssignment = (selectedRoleForNewUser === 'teacher' && newUserClassSelect) ? newUserClassSelect.value : null;

                if (!email || !password || !name) {
                    showMessage(adminUserError.id, " Please fill in email, password, and name!", false); hideLoader(); return;
                }
                if (password.length < 6) { // Basic password policy check
                    showMessage(adminUserError.id, " Password must be at least 6 characters long!", false); hideLoader(); return;
                }
                 if (selectedRoleForNewUser === 'teacher' && !classAssignment && newUserClassSelect && newUserClassSelect.options.length > 0) {
                    showMessage(adminUserError.id, " Please assign a class for the teacher role.", false); hideLoader(); return;
                }


                try {
                    // Create user with a temporary Firebase app instance to avoid session conflicts
                    const tempAppName = `secondaryApp_${Date.now()}`; 
                    const secondaryApp = firebase.initializeApp(firebaseConfig, tempAppName);
                    const secondaryAuth = secondaryApp.auth();

                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                    const newUser = userCredential.user;

                    // Save user details in Realtime Database under 'users/{uid}'
                    await database.ref('users/' + newUser.uid).set({
                        email: email, 
                        name: name, 
                        role: selectedRoleForNewUser, 
                        class: classAssignment, // Will be null if not a teacher or no class assigned
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    // Optionally, update Firebase Auth profile (displayName)
                    await newUser.updateProfile({ displayName: name }); 

                    showMessage(adminUserSuccess.id, ` User "${email}" (Role: ${selectedRoleForNewUser}) created successfully!`);
                    await logActivity('create_user_success', { createdUserEmail: email, role: selectedRoleForNewUser, assignedClass: classAssignment });
                    // Clear input fields
                    if(newUserEmailInput) newUserEmailInput.value = ''; 
                    if(newUserPasswordInput) newUserPasswordInput.value = ''; 
                    if(newUserNameInput) newUserNameInput.value = '';
                    if(newUserClassSelect) newUserClassSelect.selectedIndex = 0; // Reset class dropdown
                    
                    // Clean up temporary Firebase app
                    await secondaryAuth.signOut(); 
                    await secondaryApp.delete(); 
                } catch (error) {
                    showMessage(adminUserError.id, ` Error creating user: ${error.message}`, false);
                    await logActivity('create_user_error', { inputEmail: email, error: error.message });
                }
                hideLoader();
            });
            
            // Load users into the admin table
            function loadUsersForAdminTable() {
                if (!userListTbody) return; // Ensure table body exists
                usersDataRef.on('value', (snapshot) => { 
                    userListTbody.innerHTML = ''; // Clear existing rows
                    snapshot.forEach((childSnapshot) => {
                        const uid = childSnapshot.key;
                        const userData = childSnapshot.val();
                        
                        if (!userData) return; // Skip if userData is null/undefined

                        const tr = userListTbody.insertRow();
                        tr.innerHTML = `
                            <td>${userData.email || 'N/A'}</td>
                            <td>${userData.name || 'N/A'}</td>
                            <td><span class="role-badge badge-${userData.role || 'unknown'}">${(userData.role || 'unknown').charAt(0).toUpperCase() + (userData.role || 'unknown').slice(1)}</span></td>
                            <td>${(userData.role === 'teacher' && userData.class) ? `Class ${userData.class}` : 'N/A'}</td>
                            <td class="admin-user-actions">
                                <button class="btn btn-primary btn-sm btn-edit-user" data-uid="${uid}" title="Edit User"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm btn-delete-user" data-uid="${uid}" title="Delete User"><i class="fas fa-trash"></i></button>
                            </td>`;
                        
                        // Add event listeners for edit and delete buttons
                        const editBtn = tr.querySelector('.btn-edit-user');
                        const deleteBtn = tr.querySelector('.btn-delete-user');
                        if(editBtn) editBtn.addEventListener('click', () => openEditUserModalDialog(uid, userData));
                        if(deleteBtn) deleteBtn.addEventListener('click', () => confirmUserDeletion(uid, userData));
                    });
                }, (error) => {
                    console.error("Error loading users for admin panel:", error);
                    if(adminUserError) showMessage(adminUserError.id, "Failed to load user list.", false);
                });
            }
            
            // Open the modal to edit user details
            function openEditUserModalDialog(uid, userData) {
                currentEditUserUID = uid; 
                if(editUserNameModalInput) editUserNameModalInput.value = userData.name || '';
                if(editUserRoleModalSelect) editUserRoleModalSelect.value = userData.role || 'teacher';
                
                // Show/hide class assignment based on role in modal
                if(editClassAssignGroupModal) editClassAssignGroupModal.style.display = (userData.role === 'teacher') ? 'block' : 'none';
                if (userData.role === 'teacher' && editUserClassModalSelect) {
                    editUserClassModalSelect.value = userData.class || (Object.keys(allClassesData)[0] || ''); 
                }
                if(editUserModal) editUserModal.style.display = 'flex'; // Show modal
            }
            
            // Handle role change within the edit user modal
            if(editUserRoleModalSelect) editUserRoleModalSelect.addEventListener('change', function() {
                if(editClassAssignGroupModal) editClassAssignGroupModal.style.display = this.value === 'teacher' ? 'block' : 'none';
            });

            // Save changes from the edit user modal
            if(saveUserChangesBtn) saveUserChangesBtn.addEventListener('click', async () => {
                if (!currentEditUserUID) return;
                showLoader();
                const newName = editUserNameModalInput.value.trim();
                const newRole = editUserRoleModalSelect.value;
                const newClass = (newRole === 'teacher' && editUserClassModalSelect) ? editUserClassModalSelect.value : null;
                
                if (!newName) {
                    showMessage(editUserModalError.id, "User name cannot be empty.", false); hideLoader(); return;
                }
                if (newRole === 'teacher' && !newClass && editUserClassModalSelect && editUserClassModalSelect.options.length > 0) {
                    showMessage(editUserModalError.id, "Please assign a class for the teacher role.", false); hideLoader(); return;
                }
                
                try {
                    const updates = { 
                        name: newName, 
                        role: newRole, 
                        class: newClass, // Will be null if not teacher or no class assigned
                        updatedAt: firebase.database.ServerValue.TIMESTAMP 
                    };
                    await usersDataRef.child(currentEditUserUID).update(updates);
                    
                    // If editing the currently logged-in user, update their local state and UI
                    if (currentUser && currentUser.uid === currentEditUserUID) {
                        userDisplayName = newName; userRole = newRole; userAssignedClass = newClass;
                        updateUserUIDisplay(); 
                    }
                    showMessage(editUserModalSuccess.id, "User details updated successfully!");
                    await logActivity('edit_user_success', { targetUserUID: currentEditUserUID, changes: { name: newName, role: newRole, class: newClass} });
                    setTimeout(() => { if(editUserModal) editUserModal.style.display = 'none'; }, 2000); // Auto-close modal
                } catch (error) {
                    showMessage(editUserModalError.id, `Error updating user: ${error.message}`, false);
                     await logActivity('edit_user_error', { targetUserUID: currentEditUserUID, error: error.message });
                }
                hideLoader();
            });
            
            // Confirm user deletion (using a custom modal/dialog in a real app is better than confirm())
            function confirmUserDeletion(uid, userData) {
                if (userData.role === 'administrator' && uid === currentUser.uid) {
                    showMessage(adminUserError.id, " Administrators cannot delete their own account.", false);
                    return;
                }
                 if (userData.role === 'administrator') {
                    showMessage(adminUserError.id, " Other administrator accounts cannot be deleted from this panel for safety.", false);
                    return;
                }
                // Replace window.confirm with a custom modal for better UX in a production app
                if (window.confirm(`Are you sure you want to delete user ${userData.email || uid}? This removes them from the user list but does NOT delete their Firebase Auth account.`)) {
                    deleteUserFromDatabase(uid, userData.email || uid);
                }
            }

            // Delete user from Realtime Database (users list)
            async function deleteUserFromDatabase(uid, email) {
                showLoader();
                try {
                    await usersDataRef.child(uid).remove();
                    showMessage(adminUserSuccess.id, `User ${email} removed from application database.`);
                    await logActivity('delete_user_db_success', { deletedUserUID: uid, email: email });
                    // Note: This does not delete the Firebase Auth user. That requires Admin SDK server-side.
                } catch (error) {
                    showMessage(adminUserError.id, `Error deleting user from DB: ${error.message}`, false);
                    await logActivity('delete_user_db_error', { targetUserUID: uid, error: error.message });
                }
                hideLoader();
            }

            // --- Admin Panel - Attendance Management ---
            if(loadMgmtAttendanceBtn) loadMgmtAttendanceBtn.addEventListener('click', async () => {
                showLoader();
                const startDate = mgmtAttStartDateInput.value; // YYYY-MM-DD
                const endDate = mgmtAttEndDateInput.value;   // YYYY-MM-DD
                const selectedClass = mgmtAttClassSelector.value;

                if (!startDate || !endDate || !selectedClass) {
                    showMessage(mgmtAttendanceError.id, "Please select start date, end date, and class.", false);
                    hideLoader(); return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showMessage(mgmtAttendanceError.id, "Start date cannot be after end date.", false);
                    hideLoader(); return;
                }

                if(mgmtAttendanceTableBody) mgmtAttendanceTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Loading attendance records...</td></tr>`;
                try {
                    const attendanceRef = database.ref('attendance');
                    // Firebase RTDB: Query by date range (key) and then filter by class client-side.
                    // For very large datasets, Firestore with compound queries or server-side processing is better.
                    const snapshot = await attendanceRef.orderByKey().startAt(startDate).endAt(endDate).once('value');
                    const allDataForRange = snapshot.val() || {};
                    
                    let tableHTML = "";
                    let recordsFound = 0;

                    Object.keys(allDataForRange).sort().forEach(dateKey => { // Sort dates
                        // Check if data for the selected class exists on this date
                        if (allDataForRange[dateKey][selectedClass]) {
                            const classAttendanceData = allDataForRange[dateKey][selectedClass];
                            const studentsInThisClass = allStudentNames[selectedClass] || {}; // Get student names for this class
                            const absentRollsOnDate = new Set((classAttendanceData.absentees || []).map(a => a.roll.toString()));

                            // Iterate over all students of the selected class to show present/absent status
                            Object.entries(studentsInThisClass).sort((a,b)=> parseInt(a[0]) - parseInt(b[0])).forEach(([roll, name]) => {
                                recordsFound++;
                                const isAbsent = absentRollsOnDate.has(roll);
                                tableHTML += `
                                    <tr data-date="${dateKey}" data-class="${selectedClass}" data-roll="${roll}" data-name="${name}">
                                        <td>${dateKey.split('-').reverse().join('-')}</td> <!-- DD-MM-YYYY -->
                                        <td>Class ${selectedClass}</td>
                                        <td>${roll}</td>
                                        <td>${name}</td>
                                        <td><span class="status-indicator ${isAbsent ? 'status-absent' : 'status-present'}"></span>${isAbsent ? 'Absent' : 'Present'}</td>
                                        <td><button class="btn btn-primary btn-sm btn-edit-attendance" title="Edit Status"><i class="fas fa-edit"></i> Edit</button></td>
                                    </tr>`;
                            });
                        }
                    });
                    if(mgmtAttendanceTableBody) mgmtAttendanceTableBody.innerHTML = recordsFound > 0 ? tableHTML : `<tr><td colspan="6" style="text-align:center;">No attendance records found for the selected criteria.</td></tr>`;
                    
                    // Add event listeners to the newly created edit buttons
                    if(mgmtAttendanceTableBody) {
                        mgmtAttendanceTableBody.querySelectorAll('.btn-edit-attendance').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const row = e.target.closest('tr');
                                if (!row || !row.dataset) return;
                                currentEditingAttendanceRecord = {
                                    date: row.dataset.date,       // YYYY-MM-DD
                                    class: row.dataset.class,
                                    roll: row.dataset.roll,
                                    name: row.dataset.name,
                                    // Determine current status from cell text content robustly
                                    currentStatus: row.cells[4].textContent.toLowerCase().includes('absent') ? 'absent' : 'present'
                                };
                                if(editAttendanceStudentInfo) editAttendanceStudentInfo.textContent = `${currentEditingAttendanceRecord.name} (Roll: ${currentEditingAttendanceRecord.roll})`;
                                if(editAttendanceDateInfo) editAttendanceDateInfo.textContent = currentEditingAttendanceRecord.date.split('-').reverse().join('-'); // DD-MM-YYYY
                                if(editAttendanceClassInfo) editAttendanceClassInfo.textContent = currentEditingAttendanceRecord.class;
                                if(editAttendanceStatusSelect) editAttendanceStatusSelect.value = currentEditingAttendanceRecord.currentStatus;
                                if(editAttendanceModal) editAttendanceModal.style.display = 'flex';
                            });
                        });
                    }
                    showMessage(mgmtAttendanceSuccess.id, `Found ${recordsFound} attendance entries.`);
                    await logActivity('load_mgmt_attendance', { startDate, endDate, class: selectedClass, recordsFound });

                } catch (error) {
                    showMessage(mgmtAttendanceError.id, `Error loading attendance records: ${error.message}`, false);
                     await logActivity('load_mgmt_attendance_error', { startDate, endDate, class: selectedClass, error: error.message });
                }
                hideLoader();
            });

            // Save changes to an attendance record from the modal
            if(saveAttendanceChangeBtn) saveAttendanceChangeBtn.addEventListener('click', async () => {
                if (!currentEditingAttendanceRecord) return;
                showLoader();
                const newStatus = editAttendanceStatusSelect.value; // "present" or "absent"
                const { date, class: className, roll, name } = currentEditingAttendanceRecord;

                try {
                    const dayAttendanceRef = database.ref(`attendance/${date}/${className}`);
                    const snapshot = await dayAttendanceRef.once('value');
                    let dayData = snapshot.val();

                    if (!dayData) { // Should not happen if editing existing, but as a safeguard
                        dayData = { date: date, class: className, absentees: [] };
                    }
                    dayData.absentees = dayData.absentees || [];

                    const studentIndexInAbsentees = dayData.absentees.findIndex(s => s.roll.toString() === roll);

                    if (newStatus === 'absent') {
                        if (studentIndexInAbsentees === -1) { // If student was present and now marked absent, add to list
                            dayData.absentees.push({ roll: roll, name: name });
                        }
                    } else { // newStatus is 'present'
                        if (studentIndexInAbsentees !== -1) { // If student was absent and now marked present, remove from list
                            dayData.absentees.splice(studentIndexInAbsentees, 1);
                        }
                    }
                    // Add audit trail for edit
                    dayData.lastEditedByUID = currentUser.uid;
                    dayData.lastEditedByName = userDisplayName;
                    dayData.lastEditedAt = firebase.database.ServerValue.TIMESTAMP;

                    await dayAttendanceRef.set(dayData);
                    showMessage(editAttendanceSuccess.id, `Attendance for ${name} on ${date.split('-').reverse().join('-')} updated to ${newStatus}.`);
                    await logActivity('edit_attendance_record_success', { date, class: className, roll, name, newStatus });
                    if(editAttendanceModal) editAttendanceModal.style.display = 'none';
                    if(loadMgmtAttendanceBtn) loadMgmtAttendanceBtn.click(); // Refresh the table to show changes
                } catch (error) {
                    showMessage(editAttendanceError.id, `Error updating attendance: ${error.message}`, false);
                    await logActivity('edit_attendance_record_error', { date, class: className, roll, name, newStatus, error: error.message });
                }
                hideLoader();
            });
            
            // Save attendance settings (e.g., global start date)
            if(saveAttendanceSettingsBtn) saveAttendanceSettingsBtn.addEventListener('click', async () => {
                showLoader();
                const startDateSetting = attendanceStartDateSettingInput.value;
                if (!startDateSetting) {
                    showMessage(attendanceSettingsError.id, "Please select a valid starting date for attendance data.", false);
                    hideLoader(); return;
                }
                try {
                    await database.ref('settings/attendanceConfiguration').update({ 
                        globalAttendanceStartDate: startDateSetting, 
                        lastSetByUID: currentUser.uid,
                        lastSetByName: userDisplayName,
                        lastSetAt: firebase.database.ServerValue.TIMESTAMP 
                    });
                    showMessage(attendanceSettingsSuccess.id, "Attendance data starting date setting saved.");
                    await logActivity('save_attendance_setting', { setting: 'globalAttendanceStartDate', value: startDateSetting });
                } catch (error) {
                    showMessage(attendanceSettingsError.id, `Error saving attendance setting: ${error.message}`, false);
                    await logActivity('save_attendance_setting_error', { error: error.message });
                }
                hideLoader();
            });
            
            // Load attendance settings on page load
            async function loadAttendanceSettings() {
                try {
                    const snapshot = await database.ref('settings/attendanceConfiguration/globalAttendanceStartDate').once('value');
                    if (snapshot.exists() && attendanceStartDateSettingInput) {
                        attendanceStartDateSettingInput.value = snapshot.val();
                    }
                } catch (error) { console.error("Error loading attendance start date setting:", error); }
            }


            // --- Admin Panel - Activity Logs ---
            if(loadActivityLogsBtn) loadActivityLogsBtn.addEventListener('click', async () => {
                showLoader();
                const startDate = logStartDateInput.value; // YYYY-MM-DD
                const endDate = logEndDateInput.value;   // YYYY-MM-DD
                const userEmailFilter = logUserEmailInput.value.trim().toLowerCase();
                const actionTypeFilter = logActionTypeInput.value.trim().toLowerCase();

                if (!startDate || !endDate) {
                    showMessage(activityLogError.id, "Please select start and end dates for logs.", false);
                    hideLoader(); return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showMessage(activityLogError.id, "Start date cannot be after end date for logs.", false);
                    hideLoader(); return;
                }
                
                if(activityLogsTableBody) activityLogsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Loading activity logs...</td></tr>`;
                try {
                    const logsRef = database.ref('activityLogs');
                    // Convert dates to timestamps for Firebase RTDB query by 'timestamp' child.
                    // Note: Firebase RTDB works best with single orderByChild. Multiple filters are client-side.
                    const startTimestamp = new Date(startDate).getTime();
                    const endTimestamp = new Date(endDate).setHours(23, 59, 59, 999); // Include whole end day

                    const snapshot = await logsRef.orderByChild('timestamp').startAt(startTimestamp).endAt(endTimestamp).once('value');
                    const allLogsInRange = snapshot.val() || {};
                    
                    let tableHTML = "";
                    let logsFound = 0;
                    
                    // Client-side filtering for userEmail and actionType
                    Object.values(allLogsInRange).filter(log => {
                        if (userEmailFilter && (!log.userEmail || !log.userEmail.toLowerCase().includes(userEmailFilter))) return false;
                        if (actionTypeFilter && (!log.action || !log.action.toLowerCase().includes(actionTypeFilter))) return false;
                        return true;
                    }).sort((a,b) => b.timestamp - a.timestamp) // Sort newest first (descending timestamp)
                      .forEach(log => {
                        logsFound++;
                        const logDate = new Date(log.timestamp).toLocaleString(); // Human-readable date/time
                        let detailsString = 'N/A';
                        if (log.details) {
                            try {
                                detailsString = JSON.stringify(log.details);
                                if (detailsString.length > 100) detailsString = detailsString.substring(0, 100) + '...';
                            } catch (e) { detailsString = 'Error parsing details'; }
                        }

                        tableHTML += `
                            <tr>
                                <td>${logDate}</td>
                                <td>${log.userName || log.userEmail || 'System/Unknown'}</td>
                                <td>${log.action || 'N/A'}</td>
                                <td title="${log.details ? JSON.stringify(log.details, null, 2) : ''}">${detailsString}</td>
                            </tr>`;
                    });

                    if(activityLogsTableBody) activityLogsTableBody.innerHTML = logsFound > 0 ? tableHTML : `<tr><td colspan="4" style="text-align:center;">No activity logs found for the selected criteria.</td></tr>`;
                    showMessage(activityLogError.id, `Found ${logsFound} log entries.`, true); // Use error element for general messages too
                    await logActivity('load_activity_logs_view', { startDate, endDate, userFilter: userEmailFilter, actionFilter: actionTypeFilter, logsFound });
                } catch (error) {
                    showMessage(activityLogError.id, `Error loading activity logs: ${error.message}`, false);
                     await logActivity('load_activity_logs_error', { startDate, endDate, error: error.message });
                }
                hideLoader();
            });

            // --- Admin Panel - System Settings ---
            if(saveSystemSettingsBtn) saveSystemSettingsBtn.addEventListener('click', async () => {
                showLoader();
                const settingsToSave = {
                    schoolName: systemNameInput ? systemNameInput.value : 'AbsentEase Academy',
                    logoUrl: logoUrlInput ? logoUrlInput.value : 'https://cdn.imgchest.com/files/7mmc9jrkvv7.png',
                    notifications: {
                        email: emailNotificationsSettingCheckbox ? emailNotificationsSettingCheckbox.checked : true,
                        inApp: inAppNotificationsSettingCheckbox ? inAppNotificationsSettingCheckbox.checked : true
                    },
                    lastUpdatedByUID: currentUser.uid,
                    lastUpdatedByName: userDisplayName,
                    lastUpdatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                try {
                    await database.ref('settings/systemConfiguration').update(settingsToSave);
                    showMessage(systemSettingsSuccess.id, "System settings saved successfully.");
                    await logActivity('save_system_settings_success', settingsToSave);
                    // Apply live updates to UI if applicable
                    document.querySelectorAll('#header-logo, #attendance-header-logo, #admin-header-logo').forEach(logoEl => {
                        if(logoEl && settingsToSave.logoUrl) logoEl.src = settingsToSave.logoUrl;
                    });
                    // Update app title in header (if a specific element is targeted for it)
                    // document.getElementById('app-main-title-display').textContent = settingsToSave.schoolName;

                } catch (error) {
                    showMessage(systemSettingsError.id, `Error saving system settings: ${error.message}`, false);
                    await logActivity('save_system_settings_error', { error: error.message });
                }
                hideLoader();
            });
            
            if(saveSecuritySettingsBtn) saveSecuritySettingsBtn.addEventListener('click', async () => {
                showLoader();
                const securitySettingsToSave = {
                    passwordPolicy: passwordPolicySelect ? passwordPolicySelect.value : 'medium',
                    sessionTimeoutMinutes: sessionTimeoutSelect ? parseInt(sessionTimeoutSelect.value) : 30,
                    lastUpdatedByUID: currentUser.uid,
                    lastUpdatedByName: userDisplayName,
                    lastUpdatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                try {
                    await database.ref('settings/securityConfiguration').update(securitySettingsToSave);
                    showMessage(securitySettingsSuccess.id, "Security settings saved successfully.");
                    await logActivity('save_security_settings_success', securitySettingsToSave);
                } catch (error) {
                    showMessage(securitySettingsError.id, `Error saving security settings: ${error.message}`, false);
                    await logActivity('save_security_settings_error', { error: error.message });
                }
                hideLoader();
            });

            // Load system and security settings on page load
            async function loadSystemSettings() {
                try {
                    const sysConfigSnap = await database.ref('settings/systemConfiguration').once('value');
                    if (sysConfigSnap.exists()) {
                        const config = sysConfigSnap.val();
                        if(systemNameInput && config.schoolName) systemNameInput.value = config.schoolName;
                        if(logoUrlInput && config.logoUrl) logoUrlInput.value = config.logoUrl;
                        if(emailNotificationsSettingCheckbox && config.notifications && typeof config.notifications.email === 'boolean') emailNotificationsSettingCheckbox.checked = config.notifications.email;
                        if(inAppNotificationsSettingCheckbox && config.notifications && typeof config.notifications.inApp === 'boolean') inAppNotificationsSettingCheckbox.checked = config.notifications.inApp;
                        // Apply logo immediately to all relevant logo image elements
                         document.querySelectorAll('#header-logo, #attendance-header-logo, #admin-header-logo').forEach(logoEl => {
                            if(logoEl && config.logoUrl) logoEl.src = config.logoUrl;
                        });
                    }
                    const secConfigSnap = await database.ref('settings/securityConfiguration').once('value');
                     if (secConfigSnap.exists()) {
                        const config = secConfigSnap.val();
                        if(passwordPolicySelect && config.passwordPolicy) passwordPolicySelect.value = config.passwordPolicy;
                        if(sessionTimeoutSelect && config.sessionTimeoutMinutes !== undefined) sessionTimeoutSelect.value = config.sessionTimeoutMinutes.toString();
                    }
                } catch (error) {
                    console.error("Error loading system/security settings:", error);
                    // Optionally show a non-critical error message to admin if settings load fails
                    if (userRole === 'administrator' && systemSettingsError) {
                         showMessage(systemSettingsError.id, "Could not load all system settings.", false);
                    }
                }
            }
            
            // --- Device Management Functions (Admin Panel) ---
            async function loadDeviceSettings() {
                try {
                    const snapshot = await database.ref('settings/deviceConfiguration/maxDevicesPerUser').once('value');
                    if (snapshot.exists() && maxDevicesInput) {
                        maxDevicesInput.value = snapshot.val();
                    } else if (maxDevicesInput) {
                        maxDevicesInput.value = 3; // Default if not set
                    }
                } catch (error) {
                    console.error("Error loading device settings:", error);
                    if(userRole === 'administrator' && document.getElementById('device-settings-error')) {
                        showMessage('device-settings-error', "Could not load max device setting.", false);
                    }
                }
            }

            function setupDeviceManagementListeners() {
                if (saveDeviceSettingsBtn) {
                    saveDeviceSettingsBtn.addEventListener('click', async () => {
                        showLoader();
                        const maxDevices = maxDevicesInput ? parseInt(maxDevicesInput.value) : 3;
                        if (isNaN(maxDevices) || maxDevices < 1 || maxDevices > 10) {
                            showMessage('device-settings-error', "Max devices must be a number between 1 and 10.", false);
                            hideLoader(); return;
                        }
                        try {
                            await database.ref('settings/deviceConfiguration').update({ 
                                maxDevicesPerUser: maxDevices,
                                lastUpdatedByUID: currentUser.uid,
                                lastUpdatedByName: userDisplayName,
                                lastUpdatedAt: firebase.database.ServerValue.TIMESTAMP
                            });
                            showMessage('device-settings-success', `Max devices per user set to ${maxDevices}.`);
                            await logActivity('save_device_settings', { maxDevices: maxDevices });
                        } catch (error) {
                            showMessage('device-settings-error', `Error saving device settings: ${error.message}`, false);
                            await logActivity('save_device_settings_error', { error: error.message });
                        }
                        hideLoader();
                    });
                }
                if (deviceUserFilterInput) {
                     deviceUserFilterInput.addEventListener('input', () => loadAndDisplayUserDevices(deviceUserFilterInput.value.trim().toLowerCase()));
                }
            }
            
            async function loadAndDisplayUserDevices(filter = '') {
                 if (!userDevicesListContainer || userRole !== 'administrator') return;
                showLoader();
                userDevicesListContainer.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading devices...</td></tr>'; // Use table row for consistency if it's a table
                
                try {
                    const devicesSnapshot = await database.ref('devices').once('value');
                    const allUserDevices = devicesSnapshot.val() || {};
                    const usersSnapshot = await database.ref('users').once('value'); // For getting user names
                    const usersData = usersSnapshot.val() || {};

                    let tableContent = '';
                    let devicesFound = 0;
                    const detector = new DeviceDetector();

                    for (const userId in allUserDevices) {
                        const userEmail = usersData[userId] ? usersData[userId].email : 'Unknown User';
                        const userName = usersData[userId] ? usersData[userId].name : userId;

                        if (filter && !userEmail.toLowerCase().includes(filter) && !userName.toLowerCase().includes(filter)) {
                            continue; // Skip if filter doesn't match email or name
                        }

                        const devices = allUserDevices[userId];
                        for (const deviceKey in devices) {
                            devicesFound++;
                            const device = devices[deviceKey];
                            const parsedUA = detector.parse(device.userAgent || "");
                            const deviceType = parsedUA.device?.type || 'Unknown';
                            const browser = parsedUA.client?.name || 'Unknown';
                            const os = parsedUA.os?.name || 'Unknown';
                            const loginDate = device.date ? new Date(device.date).toLocaleDateString() : 'N/A';
                            
                            // Assuming userDevicesListContainer is a <tbody>
                            tableContent += `
                                <tr>
                                    <td>${userEmail} (${userName})</td>
                                    <td>${deviceType}</td>
                                    <td>${browser}</td>
                                    <td>${os}</td>
                                    <td>${loginDate}</td>
                                    <td><button class="btn btn-danger btn-sm btn-remove-device" data-user-id="${userId}" data-device-key="${deviceKey}"><i class="fas fa-trash"></i> Remove</button></td>
                                </tr>
                            `;
                        }
                    }
                    userDevicesListContainer.innerHTML = devicesFound > 0 ? tableContent : '<tr><td colspan="6" style="text-align:center;">No devices found matching filter or no devices registered.</td></tr>';
                    
                    // Add event listeners to new remove buttons
                    userDevicesListContainer.querySelectorAll('.btn-remove-device').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const targetButton = e.currentTarget; // Use currentTarget for delegated events
                            const userId = targetButton.dataset.userId;
                            const deviceKey = targetButton.dataset.deviceKey;
                            confirmRemoveDevice(userId, deviceKey);
                        });
                    });

                } catch (error) {
                    console.error("Error loading user devices:", error);
                    userDevicesListContainer.innerHTML = '<tr><td colspan="6" style="text-align:center;">Error loading devices.</td></tr>';
                    showMessage('device-settings-error', `Error loading devices: ${error.message}`, false);
                }
                hideLoader();
            }

            function confirmRemoveDevice(userId, deviceKey) {
                // Use a custom modal in a real app
                if (window.confirm(`Are you sure you want to remove this device for user ${userId}?`)) {
                    removeUserDevice(userId, deviceKey);
                }
            }

            async function removeUserDevice(userId, deviceKey) {
                showLoader();
                try {
                    await database.ref(`devices/${userId}/${deviceKey}`).remove();
                    showMessage('device-settings-success', "Device removed successfully.");
                    await logActivity('remove_device_success', { removedDeviceForUser: userId, deviceKey: deviceKey });
                    loadAndDisplayUserDevices(deviceUserFilterInput ? deviceUserFilterInput.value.trim().toLowerCase() : ''); // Refresh list
                } catch (error) {
                    showMessage('device-settings-error', `Error removing device: ${error.message}`, false);
                    await logActivity('remove_device_error', { error: error.message });
                }
                hideLoader();
            }
            
            // --- Initialize App ---
            initializeApp();

        }); // End of DOMContentLoaded
        
        // --- Helper function to get device details (browser, OS, etc.) ---
        function getDeviceDetails() {
            // Using DeviceDetector.js if loaded, otherwise basic navigator info
            if (typeof DeviceDetector !== 'undefined') {
                const detector = new DeviceDetector();
                const uaInfo = detector.parse(navigator.userAgent);
                return {
                    deviceType: uaInfo.device?.type || 'Unknown',
                    browser: uaInfo.client?.name || 'Unknown',
                    os: uaInfo.os?.name || 'Unknown',
                    userAgent: navigator.userAgent.substring(0, 250) // Truncate long UAs
                };
            }
            // Fallback if DeviceDetector is not available
            return {
                deviceType: /Mobi|Android|iPhone/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                browser: 'Could not detect precisely',
                os: navigator.platform || 'Unknown',
                userAgent: navigator.userAgent.substring(0, 250)
            };
        }
        
    </script>
    <!-- PDF export logic (ensure jspdf and autotable are loaded before this) -->
<script>
  // Helper function to format date as DD-MM-YYYY
  function formatDateToDDMMYYYY(dateStringOrTimestamp) {
    const date = new Date(dateStringOrTimestamp); // Handles both YYYY-MM-DD and timestamps
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
    const yyyy = date.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  window.addEventListener('DOMContentLoaded', () => {
    // Check if jsPDF and autoTable plugin are loaded
    if (typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF === 'function' && typeof window.jspdf.jsPDF.autoTable === 'function') {
      const { jsPDF } = window.jspdf;

      const downloadClassPdfBtn = document.getElementById("download-class-attendance-pdf");
      const downloadIndividualPdfBtn = document.getElementById("download-individual-attendance-pdf");

      // Function to get a nicely formatted current date and day
      const getFormattedCurrentDateForPdfHeader = () => {
        const now = new Date();
        const dayName = now.toLocaleDateString('en-US', { weekday: 'long' });
        return `${dayName}, ${formatDateToDDMMYYYY(now)}`; // Uses DD-MM-YYYY
      };

      // Get selected class name for PDF header
      const getCurrentClassNameForPdf = () => {
        const classSelect = document.getElementById("attendance-class-selector"); // Assuming this ID for class selector on attendance page
        return classSelect?.options[classSelect.selectedIndex]?.text || "Selected Class"; // Use .text for "Class X"
      };
      
      // Mock function for class teacher - replace with actual data source if available
      const getClassTeacherName = (classNameText) => {
        // Example: "Class A2" -> "A2"
        const classCode = classNameText.replace("Class ", "").trim(); 
        const classTeachers = { /* This should be populated from your data or settings */
          "A2": "Ms. Julie Vargheese", "B2": "Ms. Deepti", "C2": "Mr. Harin SK", "D2": "Ms. Anulekshmi V"
          // Add more mappings as needed
        };
        return classTeachers[classCode] || "N/A"; 
      };

      // Event listener for Class Attendance PDF download
      if (downloadClassPdfBtn) {
        downloadClassPdfBtn.addEventListener("click", () => {
          const doc = new jsPDF();
          const attendanceTable = document.querySelector("#attendance-table-body")?.closest("table");
          if (!attendanceTable) {
            alert("Class attendance table not found. Please load attendance data first.");
            return;
          }

          const selectedClassName = getCurrentClassNameForPdf();
          const teacherName = getClassTeacherName(selectedClassName);
          const reportDate = document.getElementById('date-selector')?.value; // YYYY-MM-DD
          const displayDate = reportDate ? formatDateToDDMMYYYY(reportDate) : getFormattedCurrentDateForPdfHeader();


          doc.setFontSize(16);
          doc.text("Class Attendance Report", 14, 16);
          doc.setFontSize(11);
          doc.text(`Date: ${displayDate}`, 14, 26);
          doc.text(`Class: ${selectedClassName}`, 14, 32);
          doc.text(`Class Teacher: ${teacherName}`, 14, 38);
          
          // Use autoTable to draw the table from HTML
          doc.autoTable({ 
            html: attendanceTable, 
            startY: 45,
            headStyles: { fillColor: [40, 55, 81] }, // Example: var(--primary)
            theme: 'grid'
          });
          doc.save(`class_attendance_${selectedClassName.replace(/\s+/g, '_')}_${displayDate.replace(/-/g, '')}.pdf`);
        });
      }

      // Event listener for Individual Attendance PDF download
      if (downloadIndividualPdfBtn) {
        downloadIndividualPdfBtn.addEventListener("click", () => {
          const doc = new jsPDF();
          const studentNameFull = document.getElementById("student-name-display")?.innerText || "Student"; // e.g., "Student Name (Roll: X, Class: Y)"
          const studentAttendanceTable = document.querySelector("#student-attendance-body")?.closest("table");
          if (!studentAttendanceTable) {
            alert("Student attendance records table not found. Please load records first.");
            return;
          }

          doc.setFontSize(16);
          doc.text(`Attendance Report for ${studentNameFull}`, 14, 16);
          doc.setFontSize(11);
          doc.text(`Report Generated: ${getFormattedCurrentDateForPdfHeader()}`, 14, 26);
          
          doc.autoTable({ 
            html: studentAttendanceTable, 
            startY: 35,
            headStyles: { fillColor: [40, 55, 81] },
            theme: 'grid'
          });
          doc.save(`${studentNameFull.split('(')[0].trim().replace(/\s+/g, '_').toLowerCase()}_attendance_history.pdf`);
        });
      }
    } else {
      console.warn("jsPDF or jsPDF.autoTable is not loaded. PDF export functionality will be unavailable.");
      // Optionally, disable PDF buttons if libraries aren't loaded
      document.querySelectorAll("#download-class-attendance-pdf, #download-individual-attendance-pdf").forEach(btn => {
        if(btn) {
            btn.disabled = true;
            btn.title = "PDF library not loaded.";
        }
      });
    }

    // Re-attach logout confirmation if buttons exist (ensure this runs after main script might have set up its listeners)
    // This can be tricky with load order. Consider a single point of attachment or event delegation.
    // For simplicity, this assumes the buttons are present at DOMContentLoaded.
    const allLogoutButtons = [
      document.getElementById("logout-btn"),
      document.getElementById("attendance-logout-btn"),
      document.getElementById("admin-logout-btn")
    ].filter(btn => btn); // Filter out nulls

    allLogoutButtons.forEach(btn => {
        // Clone and replace to remove any previously attached listeners to avoid multiple confirms or actions.
        // This is a bit heavy-handed; a more refined approach would be to manage listener attachment carefully.
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn); 
        
        clone.addEventListener("click", (e) => {
          e.preventDefault(); // Prevent default action if it's a link or form button
          // Use a custom modal for confirmation in a real app instead of window.confirm
          if (window.confirm("Are you sure you want to logout?")) {
            if (firebase && firebase.auth && typeof firebase.auth === 'function') { // Check if Firebase auth is available
              firebase.auth().signOut().catch(error => {
                  console.error("Error during logout:", error);
                  // Show error message to user via custom modal or message display
              });
            } else {
                console.error("Firebase auth not initialized for logout.");
            }
          }
        });
    });
  });
</script>
</body>
</html>
