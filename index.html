<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AbsentEase - Complete Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --purple: #7209b7;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #splash-logo {
            width: 120px;
            height: auto;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        #message {
            color: white;
            font-size: 1.2rem;
            text-align: center;
            margin-top: 20px;
            font-weight: 300;
            max-width: 80%;
            line-height: 1.8;
        }

        #login-screen {
            display: none;
            padding: 30px 0;
        }

        #main-screen {
            display: none;
            padding: 30px 0;
        }

        #attendance-manager-screen {
            display: none;
            padding: 30px 0;
        }
        
        /* New Admin Panel Screen */
        #admin-panel-screen {
            display: none;
            padding: 30px 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            gap: 15px;
            flex-wrap: wrap;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #header-logo {
            width: 50px;
            height: auto;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
            white-space: nowrap;
        }

        .user-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .teacher-name {
            font-weight: 500;
            font-size: 1.1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .teacher-name i {
            color: var(--primary);
        }

        .role-indicator {
            background-color: #e0f7fa;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .role-admin {
            background-color: #fce4ec;
            color: #c2185b;
        }

        .role-principal {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .role-teacher {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3ab7d8;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e08716;
        }

        .btn-purple {
            background-color: var(--purple);
            color: white;
        }

        .btn-purple:hover {
            background-color: #5a098f;
        }

        .btn-admin {
            background-color: #f72585;
            color: white;
        }

        .btn-admin:hover {
            background-color: #d11575;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e31273;
        }

        .control-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        select, input[type="text"], input[type="password"], input[type="date"], input[type="number"], input[type="email"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }

        select:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .results-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .error-message {
            color: var(--danger);
            background-color: #fdd;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .success-message {
            color: #155724;
            background-color: #d4edda;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .present {
            color: #28a745;
            font-weight: 500;
        }
        
        .absent {
            color: #dc3545;
            font-weight: 500;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .dot-present {
            background-color: #28a745;
        }
        
        .dot-absent {
            background-color: #dc3545;
        }

        .screen-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .screen-title i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .student-report-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4361ee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: #212529;
        }

        .student-details {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            color: #6c757d;
        }

        .attendance-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            flex: 1;
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .present-stat {
            color: #28a745;
        }

        .absent-stat {
            color: #dc3545;
        }

        /* Cooldown indicator */
        .cooldown-indicator {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            display: none;
        }

        .cooldown-time {
            font-weight: 600;
            color: #856404;
        }

        /* User Guide Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .guide-section {
            margin-bottom: 25px;
        }

        .guide-section h3 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guide-section h3 i {
            font-size: 1.2rem;
        }

        .guide-section ul {
            padding-left: 20px;
        }

        .guide-section li {
            margin-bottom: 8px;
        }

        .dont-show-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* Help Button */
        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 999;
        }

        /* Restricted class */
        .restricted-class {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Admin Panel Specific Styles */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .admin-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }
        
        .teacher-form .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .teacher-form .form-group {
            flex: 1 1 300px;
            margin-bottom: 0;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .badge-admin {
            background-color: #fce4ec;
            color: #c2185b;
        }
        
        .badge-principal {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .badge-teacher {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .teacher-actions {
            display: flex;
            gap: 8px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .password-container {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 40px;
            cursor: pointer;
            color: #777;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 15px;
            text-align: center;
            font-weight: 500;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .attendance-stats {
                flex-direction: column;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .brand-section, .user-section {
                width: 100%;
            }
            
            .user-section {
                align-items: flex-start;
                margin-top: 15px;
                border-top: 1px solid #eee;
                padding-top: 15px;
            }
            
            .header-buttons {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }
            
            .teacher-form .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .teacher-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.4rem;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            #header-logo {
                width: 40px;
            }
            
            .student-report-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #message {
                font-size: 1.1rem;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <img id="splash-logo" src="https://i.postimg.cc/BbnQvL6M/Mj-L4-Sl-T-removebg-preview.png" alt="AbsentEase Logo">
        <p id="message"></p>
    </div>

    <div id="login-screen">
        <div class="container">
            <div class="control-panel">
                <h2 style="margin-bottom: 20px; color: var(--primary);">üîê Login to AbsentEase</h2>
                <div class="form-group">
                    <label for="email-input"><i class="fas fa-envelope"></i> Email</label>
                    <input type="text" id="email-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password-input"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password-input" placeholder="Enter your password">
                </div>
                <div class="btn-group">
                    <button id="login-btn" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</button>
                </div>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <div id="main-screen">
        <div class="container">
            <header>
                <div class="brand-section">
                    <img id="header-logo" src="https://i.imgur.com/WhNJloy.jpeg" alt="Logo">
                    <h1>AbsentEase</h1>
                </div>
                
                <div class="user-section">
                    <div class="teacher-name" id="teacher-name">
                        <i class="fas fa-user"></i> <span id="teacher-name-text">Loading...</span>
                    </div>
                    <div class="role-indicator" id="role-indicator">
                        <i class="fas fa-user-tag"></i> <span id="role-name">Loading role...</span>
                    </div>
                    
                    <div class="header-buttons">
                        <button id="attendance-manager-btn" class="btn btn-warning">
                            <i class="fas fa-calendar-check"></i> Attendance
                        </button>
                        <button id="admin-panel-btn" class="btn btn-admin" style="display: none;">
                            <i class="fas fa-users-cog"></i> Admin Panel
                        </button>
                        <button id="logout-btn" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </header>

            <div class="cooldown-indicator" id="cooldown-indicator">
                <i class="fas fa-clock"></i> You can edit today's attendance for: 
                <span class="cooldown-time" id="cooldown-time">60 minutes</span>
            </div>

            <div class="control-panel">
                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>
                
                <div class="form-group">
                    <label for="class-selector"><i class="fas fa-users"></i> Select Class</label>
                    <select id="class-selector">
                        <option value="A1">Class A1</option>
                        <option value="A2">Class A2</option>
                        <option value="B1">Class B1</option>
                        <option value="B2">Class B2</option>
                        <option value="C1">Class C1</option>
                        <option value="C2">Class C2</option>
                        <option value="D1">Class D1</option>
                        <option value="D2">Class D2</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="roll-input"><i class="fas fa-id-card"></i> Enter Roll Numbers</label>
                    <input type="text" id="roll-input" placeholder="Example: 1, 5, 7 or 1 5 7">
                </div>

                <div class="btn-group">
                    <button id="search-btn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button id="view-all-btn" class="btn btn-secondary">
                        <i class="fas fa-list"></i> View All
                    </button>
                    <button id="share-btn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                </div>
            </div>

            <div class="results-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Attendance Manager Screen -->
    <div id="attendance-manager-screen">
        <div class="container">
            <header>
                <div class="brand-section">
                    <button id="am-back-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h1>Attendance Manager</h1>
                </div>
                
                <div class="user-section">
                    <div class="teacher-name" id="am-teacher-name">
                        <i class="fas fa-user"></i> <span id="am-teacher-name-text">Loading...</span>
                    </div>
                    <div class="role-indicator" id="am-role-indicator">
                        <i class="fas fa-user-tag"></i> <span id="am-role-name">Loading role...</span>
                    </div>
                </div>
            </header>

            <div class="screen-title">
                <i class="fas fa-calendar-alt"></i>
                <h2>Attendance Management</h2>
            </div>

            <div class="control-panel">
                <div class="error-message" id="am-error-message"></div>
                
                <div class="form-group">
                    <label for="am-class-selector"><i class="fas fa-users"></i> Select Class</label>
                    <select id="am-class-selector">
                        <option value="A1">Class A1</option>
                        <option value="A2">Class A2</option>
                        <option value="B1">Class B1</option>
                        <option value="B2">Class B2</option>
                        <option value="C1">Class C1</option>
                        <option value="C2">Class C2</option>
                        <option value="D1">Class D1</option>
                        <option value="D2">Class D2</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date-selector"><i class="fas fa-calendar"></i> Select Date</label>
                    <input type="date" id="date-selector">
                </div>

                <div id="cooldown-control" class="form-group" style="display: none;">
                    <label for="cooldown-input"><i class="fas fa-clock"></i> Cooldown Period (minutes)</label>
                    <input type="number" id="cooldown-input" min="5" max="240" value="60">
                </div>

                <div class="btn-group">
                    <button id="view-attendance-btn" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View Attendance
                    </button>
                    <button id="student-report-btn" class="btn btn-purple">
                        <i class="fas fa-user-graduate"></i> Student Report
                    </button>
                </div>
            </div>

            <div class="results-container" id="attendance-results-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="am-results-table-body">
                    </tbody>
                </table>
            </div>

            <!-- Student Attendance Report Section -->
            <div id="student-report-container" style="display: none;">
                <div class="screen-title">
                    <i class="fas fa-chart-line"></i>
                    <h2>Individual Student Report</h2>
                </div>
                
                <div class="control-panel">
                    <div class="form-group">
                        <label for="student-selector"><i class="fas fa-user-graduate"></i> Select Student</label>
                        <select id="student-selector">
                            <option value="">Select a student</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button id="generate-report-btn" class="btn btn-primary">
                            <i class="fas fa-file-alt"></i> Generate Report
                        </button>
                    </div>
                </div>
                
                <div id="student-report-content" style="display: none;">
                    <div class="student-report-header">
                        <div class="student-avatar" id="student-avatar">S</div>
                        <div class="student-info">
                            <div class="student-name" id="student-name">Student Name</div>
                            <div class="student-details">
                                <span><i class="fas fa-graduation-cap"></i> Class: <span id="student-class">A1</span></span>
                                <span><i class="fas fa-hashtag"></i> Roll No: <span id="student-roll">1</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="attendance-stats">
                        <div class="stat-card">
                            <div class="stat-value present-stat" id="present-stat">0</div>
                            <div class="stat-label">Days Present</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value absent-stat" id="absent-stat">0</div>
                            <div class="stat-label">Days Absent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="attendance-percent">0%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>
                    
                    <div class="results-container">
                        <h3 style="margin-bottom: 15px;">Absence Records</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Day</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="student-attendance-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel Screen -->
    <div id="admin-panel-screen">
        <div class="container">
            <header>
                <div class="brand-section">
                    <button id="admin-back-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h1>Admin Panel</h1>
                </div>
                
                <div class="user-section">
                    <div class="teacher-name" id="admin-teacher-name">
                        <i class="fas fa-user"></i> <span id="admin-teacher-name-text">Loading...</span>
                    </div>
                    <div class="role-indicator" id="admin-role-indicator">
                        <i class="fas fa-user-tag"></i> <span id="admin-role-name">Admin</span>
                    </div>
                </div>
            </header>
            
            <div class="admin-header">
                <div>
                    <h2><i class="fas fa-users-cog"></i> Teacher Account Management</h2>
                    <p>Create, edit and manage teacher accounts</p>
                </div>
                <button id="add-teacher-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Teacher
                </button>
            </div>
            
            <div class="admin-card">
                <div class="error-message" id="admin-error-message"></div>
                <div class="success-message" id="admin-success-message"></div>
                
                <div class="teacher-form" id="teacher-form" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="teacher-name-input"><i class="fas fa-user"></i> Full Name</label>
                            <input type="text" id="teacher-name-input" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="teacher-email-input"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="teacher-email-input" placeholder="Enter email">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="teacher-role-select"><i class="fas fa-user-tag"></i> Role</label>
                            <select id="teacher-role-select">
                                <option value="teacher">Teacher</option>
                                <option value="principal">Principal</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="teacher-class-select"><i class="fas fa-users"></i> Assigned Class</label>
                            <select id="teacher-class-select">
                                <option value="A1">Class A1</option>
                                <option value="A2">Class A2</option>
                                <option value="B1">Class B1</option>
                                <option value="B2">Class B2</option>
                                <option value="C1">Class C1</option>
                                <option value="C2">Class C2</option>
                                <option value="D1">Class D1</option>
                                <option value="D2">Class D2</option>
                                <option value="All">All Classes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group password-container">
                            <label for="teacher-password-input"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="teacher-password-input" placeholder="Set password">
                            <span class="password-toggle" id="password-toggle">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                        <div class="form-group">
                            <label for="teacher-display-name"><i class="fas fa-id-card"></i> Display Name</label>
                            <input type="text" id="teacher-display-name" placeholder="Name to show in system">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button id="save-teacher-btn" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Teacher
                        </button>
                        <button id="cancel-teacher-btn" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div class="results-container">
                    <h3 style="margin-bottom: 15px;">Current Teachers</h3>
                    <div class="loading-spinner" id="teachers-loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Loading teacher accounts...</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Class</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teachers-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-card">
                <div class="screen-title">
                    <i class="fas fa-chart-bar"></i>
                    <h2>System Statistics</h2>
                </div>
                
                <div class="attendance-stats">
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">8</div>
                        <div class="stat-label">Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">240</div>
                        <div class="stat-label">Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">94%</div>
                        <div class="stat-label">Avg. Attendance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBBSXXDKjH2kk7c8oaMPEZLDPrbi9L4is4",
            authDomain: "cvkm-52da0.firebaseapp.com",
            databaseURL: "https://cvkm-52da0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cvkm-52da0",
            storageBucket: "cvkm-52da0.firebasestorage.app",
            messagingSenderId: "733824760937",
            appId: "1:733824760937:web:5ff6522ac364e55f9d36f8",
            measurementId: "G-R330EPDEMG"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Sample admin user
        const adminUser = {
            "admin@absentease.com": { 
                role: "admin", 
                name: "System Admin",
                displayName: "Administrator User",
                class: "All"
            }
        };

        document.addEventListener("DOMContentLoaded", function () {
            // Screen elements
            const splashScreen = document.getElementById("splash-screen");
            const loginScreen = document.getElementById("login-screen");
            const mainScreen = document.getElementById("main-screen");
            const attendanceManagerScreen = document.getElementById("attendance-manager-screen");
            const adminPanelScreen = document.getElementById("admin-panel-screen");
            const messageEl = document.getElementById("message");
            
            // Login elements
            const loginBtn = document.getElementById("login-btn");
            const emailInput = document.getElementById("email-input");
            const passwordInput = document.getElementById("password-input");
            const loginError = document.getElementById("login-error");
            const logoutBtn = document.getElementById("logout-btn");

            // Main screen elements
            const errorMessage = document.getElementById("error-message");
            const successMessage = document.getElementById("success-message");
            const rollInput = document.getElementById("roll-input");
            const searchBtn = document.getElementById("search-btn");
            const viewAllBtn = document.getElementById("view-all-btn");
            const shareBtn = document.getElementById("share-btn");
            const resultsTableBody = document.getElementById("results-table-body");
            const classSelector = document.getElementById("class-selector");
            const attendanceManagerBtn = document.getElementById("attendance-manager-btn");
            const adminPanelBtn = document.getElementById("admin-panel-btn");
            const cooldownIndicator = document.getElementById("cooldown-indicator");
            const cooldownTime = document.getElementById("cooldown-time");
            const roleIndicator = document.getElementById("role-indicator");
            const roleName = document.getElementById("role-name");
            const teacherName = document.getElementById("teacher-name-text");
            const amTeacherName = document.getElementById("am-teacher-name-text");
            const adminTeacherName = document.getElementById("admin-teacher-name-text");

            // Attendance manager elements
            const amBackBtn = document.getElementById("am-back-btn");
            const amClassSelector = document.getElementById("am-class-selector");
            const dateSelector = document.getElementById("date-selector");
            const cooldownInput = document.getElementById("cooldown-input");
            const viewAttendanceBtn = document.getElementById("view-attendance-btn");
            const studentReportBtn = document.getElementById("student-report-btn");
            const amResultsTableBody = document.getElementById("am-results-table-body");
            const amErrorMessage = document.getElementById("am-error-message");
            const attendanceResultsContainer = document.getElementById("attendance-results-container");
            const amRoleIndicator = document.getElementById("am-role-indicator");
            const amRoleName = document.getElementById("am-role-name");
            const cooldownControl = document.getElementById("cooldown-control");
            
            // Student report elements
            const studentSelector = document.getElementById("student-selector");
            const generateReportBtn = document.getElementById("generate-report-btn");
            const studentReportContent = document.getElementById("student-report-content");
            const studentAvatar = document.getElementById("student-avatar");
            const studentName = document.getElementById("student-name");
            const studentClass = document.getElementById("student-class");
            const studentRoll = document.getElementById("student-roll");
            const presentStat = document.getElementById("present-stat");
            const absentStat = document.getElementById("absent-stat");
            const attendancePercent = document.getElementById("attendance-percent");
            const studentAttendanceTable = document.getElementById("student-attendance-table");

            // Admin panel elements
            const adminBackBtn = document.getElementById("admin-back-btn");
            const addTeacherBtn = document.getElementById("add-teacher-btn");
            const teacherForm = document.getElementById("teacher-form");
            const saveTeacherBtn = document.getElementById("save-teacher-btn");
            const cancelTeacherBtn = document.getElementById("cancel-teacher-btn");
            const teachersTableBody = document.getElementById("teachers-table-body");
            const adminErrorMessage = document.getElementById("admin-error-message");
            const adminSuccessMessage = document.getElementById("admin-success-message");
            const passwordToggle = document.getElementById("password-toggle");
            const teacherNameInput = document.getElementById("teacher-name-input");
            const teacherEmailInput = document.getElementById("teacher-email-input");
            const teacherRoleSelect = document.getElementById("teacher-role-select");
            const teacherClassSelect = document.getElementById("teacher-class-select");
            const teacherPasswordInput = document.getElementById("teacher-password-input");
            const teacherDisplayName = document.getElementById("teacher-display-name");
            const teachersLoading = document.getElementById("teachers-loading");

            // Set today's date as default
            const today = new Date();
            dateSelector.valueAsDate = today;

            // Cooldown period in minutes (default 60 minutes)
            let cooldownPeriod = 60;
            
            // Timestamp for last attendance update
            let lastAttendanceUpdate = null;
            
            // Cooldown timer reference
            let cooldownTimer = null;
            
            // Current user role
            let currentUserRole = null;
            let currentUserClass = null;
            
            // Track if we're editing a teacher
            let editingTeacherEmail = null;

            const welcomeMessage = "Welcome to our App!\nMade By 2023-25 Cs Students....";

            auth.onAuthStateChanged(async (user) => {
                await handleSplashScreen();
                if (user) {
                    // Determine user role based on email
                    const userEmail = user.email;
                    const userRoleInfo = adminUser[userEmail] || {};
                    currentUserRole = userRoleInfo.role || "teacher";
                    currentUserClass = userRoleInfo.class;
                    
                    // Update user display
                    const displayName = userRoleInfo.displayName || userRoleInfo.name || "Teacher";
                    teacherName.textContent = displayName;
                    amTeacherName.textContent = displayName;
                    adminTeacherName.textContent = displayName;
                    
                    // Update role indicators
                    roleName.textContent = userRoleInfo.name || "Teacher";
                    amRoleName.textContent = userRoleInfo.name || "Teacher";
                    
                    // Apply role-based styling
                    roleIndicator.className = "role-indicator " + "role-" + currentUserRole;
                    amRoleIndicator.className = "role-indicator " + "role-" + currentUserRole;
                    
                    // Apply role-based restrictions
                    applyRoleRestrictions();
                    
                    // Show admin panel button only for admins
                    if (currentUserRole === "admin") {
                        adminPanelBtn.style.display = "inline-block";
                    }
                    
                    loginScreen.style.display = "none";
                    mainScreen.style.display = "block";
                    
                    // Check if we have a cooldown period from last session
                    const savedCooldown = localStorage.getItem('cooldownPeriod');
                    if (savedCooldown) {
                        cooldownPeriod = parseInt(savedCooldown);
                        if (cooldownInput) cooldownInput.value = cooldownPeriod;
                    }
                    
                    // Start cooldown timer if needed
                    startCooldownTimer();
                    
                    // Load teachers for admin panel
                    if (currentUserRole === "admin") {
                        loadTeachers();
                    }
                } else {
                    mainScreen.style.display = "none";
                    loginScreen.style.display = "block";
                }
            });

            async function handleSplashScreen() {
                await typeMessage(welcomeMessage);
                splashScreen.classList.add("fade-out");
                setTimeout(() => {
                    splashScreen.style.display = "none";
                }, 500);
            }

            function typeMessage(msg) {
                return new Promise(resolve => {
                    let index = 0;
                    function type() {
                        if (index < msg.length) {
                            messageEl.innerHTML += msg[index] === '\n' ? '<br>' : msg[index];
                            index++;
                            setTimeout(type, 50);
                        } else {
                            setTimeout(resolve, 1500);
                        }
                    }
                    type();
                });
            }

            // Apply role-based restrictions
            function applyRoleRestrictions() {
                // Main screen class selector
                if (classSelector) {
                    for (let i = 0; i < classSelector.options.length; i++) {
                        const option = classSelector.options[i];
                        
                        if (currentUserRole === "teacher") {
                            if (option.value === currentUserClass) {
                                option.selected = true;
                                option.disabled = false;
                                option.parentElement.disabled = false;
                                option.classList.remove("restricted-class");
                            } else {
                                option.disabled = true;
                                option.classList.add("restricted-class");
                            }
                        } else {
                            option.disabled = false;
                            option.classList.remove("restricted-class");
                        }
                    }
                }
                
                // Attendance manager class selector
                if (amClassSelector) {
                    for (let i = 0; i < amClassSelector.options.length; i++) {
                        const option = amClassSelector.options[i];
                        
                        if (currentUserRole === "teacher") {
                            if (option.value === currentUserClass) {
                                option.selected = true;
                                option.disabled = false;
                                option.parentElement.disabled = false;
                                option.classList.remove("restricted-class");
                            } else {
                                option.disabled = true;
                                option.classList.add("restricted-class");
                            }
                        } else {
                            option.disabled = false;
                            option.classList.remove("restricted-class");
                        }
                    }
                }
                
                // Cooldown control - only for admin
                if (cooldownControl) {
                    cooldownControl.style.display = currentUserRole === "admin" ? "block" : "none";
                }
            }
            
            // Load teachers for admin panel
            async function loadTeachers() {
                teachersTableBody.innerHTML = "";
                teachersLoading.style.display = "flex";
                
                try {
                    // Simulate loading time
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Get teachers from Firebase
                    const snapshot = await database.ref('teachers').once('value');
                    const teachers = snapshot.val();

                    teachersLoading.style.display = "none";
                    
                    if (!teachers) {
                        teachersTableBody.innerHTML = '<tr><td colspan="5">No teacher accounts found</td></tr>';
                        return;
                    }

                    // Clear the table
                    teachersTableBody.innerHTML = '';

                    // Loop through each teacher
                    Object.keys(teachers).forEach(uid => {
                        const teacher = teachers[uid];
                        // Role badge
                        let badgeClass = "badge-teacher";
                        let badgeText = "Teacher";
                        
                        if (teacher.role === "admin") {
                            badgeClass = "badge-admin";
                            badgeText = "Admin";
                        } else if (teacher.role === "principal") {
                            badgeClass = "badge-principal";
                            badgeText = "Principal";
                        }
                        
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${teacher.name}</td>
                            <td>${teacher.email}</td>
                            <td><span class="role-badge ${badgeClass}">${badgeText}</span></td>
                            <td>${teacher.class}</td>
                            <td class="teacher-actions">
                                <button class="btn btn-sm btn-primary edit-teacher" data-uid="${uid}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger delete-teacher" data-uid="${uid}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        `;
                        teachersTableBody.appendChild(tr);
                    });

                    // Update teacher count
                    document.querySelector('.stat-card .stat-value').textContent = Object.keys(teachers).length;
                    
                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('.edit-teacher').forEach(button => {
                        button.addEventListener('click', function() {
                            const uid = this.getAttribute('data-uid');
                            editTeacher(uid);
                        });
                    });
                    
                    document.querySelectorAll('.delete-teacher').forEach(button => {
                        button.addEventListener('click', function() {
                            const uid = this.getAttribute('data-uid');
                            deleteTeacher(uid);
                        });
                    });
                    
                } catch (error) {
                    teachersLoading.style.display = "none";
                    teachersTableBody.innerHTML = '<tr><td colspan="5">Error loading teachers</td></tr>';
                    console.error("Error loading teachers:", error);
                }
            }
            
            // Edit teacher function
            function editTeacher(uid) {
                // Get teacher from database
                database.ref(`teachers/${uid}`).once('value').then(snapshot => {
                    const teacher = snapshot.val();
                    
                    if (teacher) {
                        // Fill the form with teacher data
                        teacherNameInput.value = teacher.name;
                        teacherEmailInput.value = teacher.email;
                        teacherEmailInput.disabled = true;
                        teacherRoleSelect.value = teacher.role;
                        teacherClassSelect.value = teacher.class;
                        teacherDisplayName.value = teacher.displayName;
                        teacherPasswordInput.value = "";
                        
                        // Set editing state
                        editingTeacherEmail = teacher.email;
                        
                        // Show the form
                        teacherForm.style.display = "block";
                        
                        // Scroll to form
                        teacherForm.scrollIntoView({ behavior: 'smooth' });
                        
                        // Show success message
                        adminSuccessMessage.textContent = `Editing teacher: ${teacher.name}`;
                        adminSuccessMessage.style.display = "block";
                    }
                });
            }
            
            // Delete teacher function
            function deleteTeacher(uid) {
                if (confirm("Are you sure you want to delete this teacher account? This action cannot be undone.")) {
                    // Show loading
                    const deleteBtn = document.querySelector(`.delete-teacher[data-uid="${uid}"]`);
                    const originalText = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    // Delete from database
                    database.ref(`teachers/${uid}`).remove().then(() => {
                        // Reload teachers
                        loadTeachers();
                        
                        // Show success message
                        adminSuccessMessage.textContent = "Teacher account deleted successfully!";
                        adminSuccessMessage.style.display = "block";
                        setTimeout(() => {
                            adminSuccessMessage.style.display = "none";
                        }, 3000);
                    }).catch(error => {
                        adminErrorMessage.textContent = `Error deleting account: ${error.message}`;
                        adminErrorMessage.style.display = "block";
                    }).finally(() => {
                        deleteBtn.innerHTML = originalText;
                    });
                }
            }
            
            // Create a new teacher account
            async function createTeacherAccount() {
                // Get form values
                const name = teacherNameInput.value.trim();
                const email = teacherEmailInput.value.trim();
                const role = teacherRoleSelect.value;
                const assignedClass = teacherClassSelect.value;
                const password = teacherPasswordInput.value;
                const displayName = teacherDisplayName.value.trim();
                
                // Validation
                if (!name || !email || !password || !displayName) {
                    adminErrorMessage.textContent = "Please fill in all required fields";
                    adminErrorMessage.style.display = "block";
                    return;
                }
                
                if (password.length < 6) {
                    adminErrorMessage.textContent = "Password must be at least 6 characters";
                    adminErrorMessage.style.display = "block";
                    return;
                }
                
                try {
                    // Show loading on save button
                    const originalSaveText = saveTeacherBtn.innerHTML;
                    saveTeacherBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                    saveTeacherBtn.disabled = true;
                    
                    // Create user in Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Save additional teacher data to Realtime Database
                    const teacherData = {
                        name,
                        email,
                        role,
                        class: assignedClass,
                        displayName,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Save under 'teachers' node with the user's UID as key
                    await database.ref(`teachers/${user.uid}`).set(teacherData);
                    
                    // Update the user profile with display name (optional)
                    await user.updateProfile({
                        displayName: displayName
                    });
                    
                    // Show success message
                    adminSuccessMessage.textContent = `Teacher account for ${name} created successfully!`;
                    adminSuccessMessage.style.display = "block";
                    
                    // Refresh the teacher list
                    await loadTeachers();
                    
                    // Reset form and hide
                    cancelTeacherForm();
                    
                } catch (error) {
                    adminErrorMessage.textContent = `Error creating account: ${error.message}`;
                    adminErrorMessage.style.display = "block";
                } finally {
                    // Restore save button
                    saveTeacherBtn.innerHTML = originalSaveText;
                    saveTeacherBtn.disabled = false;
                }
            }
            
            // Cancel teacher form
            function cancelTeacherForm() {
                teacherForm.style.display = "none";
                editingTeacherEmail = null;
                teacherNameInput.value = "";
                teacherEmailInput.value = "";
                teacherEmailInput.disabled = false;
                teacherRoleSelect.value = "teacher";
                teacherClassSelect.value = "A1";
                teacherPasswordInput.value = "";
                teacherDisplayName.value = "";
            }
            
            // Toggle password visibility
            passwordToggle.addEventListener('click', function() {
                const type = teacherPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                teacherPasswordInput.setAttribute('type', type);
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });

            loginBtn.addEventListener("click", () => {
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                if (!email || !password) {
                    loginError.innerHTML = "Please fill in both fields.";
                    loginError.style.display = "block";
                    return;
                }

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        loginError.style.display = "none";
                    })
                    .catch(error => {
                        loginError.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
                        loginError.style.display = "block";
                    });
            });

            logoutBtn.addEventListener("click", () => {
                auth.signOut();
            });

            let studentsRef;

            classSelector.addEventListener('change', () => {
                const selectedClass = classSelector.value;
                studentsRef = database.ref(`classes/${selectedClass}`);
            });

            // Initialize the class selector
            if (classSelector) {
                classSelector.dispatchEvent(new Event('change'));
            }

            // Copy the class options to the attendance manager screen
            if (amClassSelector && classSelector) {
                amClassSelector.innerHTML = classSelector.innerHTML;
            }
            
            // Update cooldown period when changed
            if (cooldownInput) {
                cooldownInput.addEventListener('change', () => {
                    cooldownPeriod = parseInt(cooldownInput.value) || 60;
                    localStorage.setItem('cooldownPeriod', cooldownPeriod.toString());
                    
                    // Update the timer if it's running
                    if (cooldownTimer) {
                        clearInterval(cooldownTimer);
                        startCooldownTimer();
                    }
                });
            }

            // Navigation between screens
            attendanceManagerBtn.addEventListener('click', () => {
                mainScreen.style.display = 'none';
                attendanceManagerScreen.style.display = 'block';
                
                // Reapply restrictions when switching screens
                applyRoleRestrictions();
            });
            
            adminPanelBtn.addEventListener('click', () => {
                mainScreen.style.display = 'none';
                adminPanelScreen.style.display = 'block';
            });

            amBackBtn.addEventListener('click', () => {
                attendanceManagerScreen.style.display = 'none';
                mainScreen.style.display = 'block';
            });
            
            adminBackBtn.addEventListener('click', () => {
                adminPanelScreen.style.display = 'none';
                mainScreen.style.display = 'block';
            });

            // Toggle between attendance view and student report
            studentReportBtn.addEventListener('click', () => {
                attendanceResultsContainer.style.display = 'none';
                studentReportContainer.style.display = 'block';
                populateStudentSelector();
            });
            
            viewAttendanceBtn.addEventListener('click', () => {
                attendanceResultsContainer.style.display = 'block';
                studentReportContainer.style.display = 'none';
            });
            
            // Teacher form buttons
            addTeacherBtn.addEventListener('click', () => {
                teacherForm.style.display = "block";
                editingTeacherEmail = null;
                teacherNameInput.value = "";
                teacherEmailInput.value = "";
                teacherEmailInput.disabled = false;
                teacherRoleSelect.value = "teacher";
                teacherClassSelect.value = "A1";
                teacherPasswordInput.value = "";
                teacherDisplayName.value = "";
                
                // Scroll to form
                teacherForm.scrollIntoView({ behavior: 'smooth' });
            });
            
            saveTeacherBtn.addEventListener('click', createTeacherAccount);
            cancelTeacherBtn.addEventListener('click', cancelTeacherForm);

            // Populate student selector
            function populateStudentSelector() {
                const selectedClass = amClassSelector.value;
                const classRef = database.ref(`classes/${selectedClass}`);
                
                classRef.once('value').then(snapshot => {
                    const students = snapshot.val() || [];
                    studentSelector.innerHTML = '<option value="">Select a student</option>';
                    
                    students.forEach((name, index) => {
                        if (index > 0 && name && name !== "Coming Soon") {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${index} - ${name}`;
                            studentSelector.appendChild(option);
                        }
                    });
                });
            }

            searchBtn.addEventListener('click', async () => {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';

                const rollInputVal = rollInput.value.trim();
                // Convert to numbers, filter out non-numbers, then remove duplicates
                const rollNumbers = [...new Set(
                    rollInputVal.split(/[,\s]+/)
                        .map(num => parseInt(num))
                        .filter(n => !isNaN(n))
                )];

                if (!rollNumbers.length) {
                    errorMessage.textContent = "Please enter valid roll numbers";
                    errorMessage.style.display = 'block';
                    return;
                }

                try {
                    const snapshot = await studentsRef.once('value');
                    const studentArray = snapshot.val() || [];

                    const results = rollNumbers.map(roll => {
                        const name = studentArray[roll];
                        return name && name !== "Coming Soon" && name !== "\"Coming Soon\"" ?
                            `<tr><td>${roll}</td><td>${name}</td></tr>` :
                            `<tr class="error-row"><td>${roll}</td><td>Not Found</td></tr>`;
                    });

                    resultsTableBody.innerHTML = results.join('');
                    shareBtn.style.display = 'inline-block';
                } catch (error) {
                    errorMessage.textContent = `Error fetching data: ${error.message}`;
                    errorMessage.style.display = 'block';
                }
            });

            viewAllBtn.addEventListener('click', async () => {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                try {
                    const snapshot = await studentsRef.once('value');
                    const studentArray = snapshot.val() || [];

                    const results = studentArray
                        .map((name, index) => {
                            if (!name || name === "Coming Soon" || name === "\"Coming Soon\"") return null;
                            return `<tr><td>${index}</td><td>${name}</td></tr>`;
                        })
                        .filter(row => row !== null);

                    resultsTableBody.innerHTML = results.join('');
                    shareBtn.style.display = 'inline-block';
                    rollInput.value = '';
                } catch (error) {
                    errorMessage.textContent = `Error fetching data: ${error.message}`;
                    errorMessage.style.display = 'block';
                }
            });

            // Function to record attendance
            async function recordAttendance(absentRollNumbers) {
                const selectedClass = classSelector.value;
                const today = new Date().toISOString().split('T')[0];
                const now = new Date().getTime();
                
                try {
                    // Get existing record if any
                    const attendanceRef = database.ref(`attendance/${selectedClass}/${today}`);
                    const existingSnapshot = await attendanceRef.once('value');
                    const existingData = existingSnapshot.val();
                    
                    // Check if we're within cooldown period
                    if (existingData && existingData.timestamp) {
                        const timeDiff = now - existingData.timestamp;
                        const cooldownMs = cooldownPeriod * 60 * 1000;
                        
                        if (timeDiff < cooldownMs) {
                            // Within cooldown period - allow editing
                            const remaining = Math.ceil((cooldownMs - timeDiff) / 60000);
                            const confirmEdit = confirm(`You can edit attendance for ${remaining} more minutes. Overwrite existing attendance?`);
                            
                            if (!confirmEdit) {
                                return false;
                            }
                        } else {
                            // Outside cooldown period - ask for confirmation
                            const confirmOverwrite = confirm(`Cooldown period has ended. Overwriting will reset the cooldown. Proceed?`);
                            
                            if (!confirmOverwrite) {
                                return false;
                            }
                        }
                    }
                    
                    // Get all students
                    const snapshot = await database.ref(`classes/${selectedClass}`).once('value');
                    const studentArray = snapshot.val() || [];
                    
                    // Calculate present students
                    const presentRollNumbers = [];
                    for (let i = 1; i < studentArray.length; i++) {
                        if (studentArray[i] && !absentRollNumbers.includes(i)) {
                            presentRollNumbers.push(i);
                        }
                    }
                    
                    // Save to database with timestamp
                    await attendanceRef.set({
                        date: today,
                        class: selectedClass,
                        present: presentRollNumbers,
                        timestamp: now
                    });
                    
                    // Store the last update time
                    lastAttendanceUpdate = now;
                    localStorage.setItem('lastAttendanceUpdate', now.toString());
                    
                    return true;
                } catch (error) {
                    console.error("Error recording attendance:", error);
                    return false;
                }
            }

            // Start the cooldown timer
            function startCooldownTimer() {
                // Clear any existing timer
                if (cooldownTimer) {
                    clearInterval(cooldownTimer);
                }
                
                // Check if we have a last update time
                const savedUpdate = localStorage.getItem('lastAttendanceUpdate');
                if (savedUpdate) {
                    lastAttendanceUpdate = parseInt(savedUpdate);
                    const now = new Date().getTime();
                    const timeDiff = now - lastAttendanceUpdate;
                    const cooldownMs = cooldownPeriod * 60 * 1000;
                    
                    if (timeDiff < cooldownMs) {
                        // Still within cooldown period
                        cooldownIndicator.style.display = 'block';
                        
                        // Update the timer every minute
                        cooldownTimer = setInterval(() => {
                            const now = new Date().getTime();
                            const timeDiff = now - lastAttendanceUpdate;
                            const remainingMs = cooldownMs - timeDiff;
                            
                            if (remainingMs <= 0) {
                                clearInterval(cooldownTimer);
                                cooldownIndicator.style.display = 'none';
                            } else {
                                const remainingMinutes = Math.ceil(remainingMs / 60000);
                                cooldownTime.textContent = `${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
                            }
                        }, 60000); // Update every minute
                        
                        // Initial update
                        const remainingMinutes = Math.ceil((cooldownMs - timeDiff) / 60000);
                        cooldownTime.textContent = `${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
                    }
                }
            }

            shareBtn.addEventListener('click', async () => {
                // Get current date in DD-MM-YYYY format
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                const todayFormatted = `${dd}-${mm}-${yyyy}`;

                // Get all the rows from the table
                const rows = resultsTableBody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    errorMessage.textContent = "No absentees to share";
                    errorMessage.style.display = 'block';
                    return;
                }

                // Format the data for sharing in your requested structure
                let shareText = `Today's Absentees (${todayFormatted})\n`;
                shareText += '------------------------------------------\n';
                
                // Record absentees
                const absentRollNumbers = [];
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    shareText += `${cells[1].textContent}\n`; // Only student names
                    absentRollNumbers.push(parseInt(cells[0].textContent));
                });

                // Record attendance
                const recordSuccess = await recordAttendance(absentRollNumbers);
                
                if (recordSuccess) {
                    successMessage.textContent = "Attendance recorded successfully!";
                    successMessage.style.display = 'block';
                    
                    // Start the cooldown timer
                    startCooldownTimer();
                }

                // Try Web Share API first (mobile devices)
                if (navigator.share) {
                    navigator.share({
                        title: `Today's Absentees - ${todayFormatted}`,
                        text: shareText
                    }).catch(err => {
                        console.error('Error sharing:', err);
                        fallbackShare(shareText);
                    });
                } else {
                    fallbackShare(shareText);
                }
            });

            // Fallback for browsers that don't support Web Share API
            function fallbackShare(text) {
                // Create a temporary textarea for better copy compatibility
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (successful) {
                        alert('Absentees list copied to clipboard!');
                    } else {
                        throw new Error('Copy failed');
                    }
                } catch (err) {
                    // Final fallback - show the data in an alert
                    alert('Absentees list:\n\n' + text);
                }
            }

            // View attendance records
            viewAttendanceBtn.addEventListener('click', async () => {
                amErrorMessage.style.display = 'none';
                
                const selectedClass = amClassSelector.value;
                const date = dateSelector.value;
                
                if (!date) {
                    amErrorMessage.textContent = "Please select a date";
                    amErrorMessage.style.display = 'block';
                    return;
                }

                try {
                    // Get attendance record
                    const attendanceRef = database.ref(`attendance/${selectedClass}/${date}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    const attendanceData = attendanceSnapshot.val();
                    
                    // Get student data
                    const classRef = database.ref(`classes/${selectedClass}`);
                    const classSnapshot = await classRef.once('value');
                    const studentArray = classSnapshot.val() || [];
                    
                    if (!studentArray || studentArray.length === 0) {
                        amResultsTableBody.innerHTML = `<tr><td colspan="3">No student data found for this class</td></tr>`;
                        return;
                    }
                    
                    // Generate table
                    let tableHTML = '';
                    const presentRolls = attendanceData ? attendanceData.present : [];
                    
                    for (let roll = 1; roll < studentArray.length; roll++) {
                        const name = studentArray[roll];
                        if (name && name !== "Coming Soon") {
                            const isPresent = presentRolls.includes(roll);
                            const status = isPresent ? 
                                '<span class="present"><span class="status-dot dot-present"></span>Present</span>' : 
                                '<span class="absent"><span class="status-dot dot-absent"></span>Absent</span>';
                            
                            tableHTML += `<tr>
                                <td>${roll}</td>
                                <td>${name}</td>
                                <td>${status}</td>
                            </tr>`;
                        }
                    }
                    
                    if (tableHTML === '') {
                        tableHTML = `<tr><td colspan="3">No attendance data available for ${date}</td></tr>`;
                    }
                    
                    amResultsTableBody.innerHTML = tableHTML;
                    
                } catch (error) {
                    console.error("Error loading attendance:", error);
                    amResultsTableBody.innerHTML = `<tr><td colspan="3">Error loading data</td></tr>`;
                }
            });
            
            // Generate individual student report
            generateReportBtn.addEventListener('click', async () => {
                const studentInfo = studentSelector.value;
                if (!studentInfo) {
                    alert("Please select a student");
                    return;
                }
                
                const [roll, name] = studentSelector.options[studentSelector.selectedIndex].text.split(' - ');
                const selectedClass = amClassSelector.value;
                
                // Update student info display
                studentAvatar.textContent = name.charAt(0);
                studentName.textContent = name;
                studentClass.textContent = selectedClass;
                studentRoll.textContent = roll;
                
                try {
                    // Get all attendance records for this class
                    const attendanceRef = database.ref(`attendance/${selectedClass}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    const attendanceData = attendanceSnapshot.val();
                    
                    let presentDays = 0;
                    let absentDays = 0;
                    let attendanceTableHTML = '';
                    
                    // Iterate through all dates
                    if (attendanceData) {
                        Object.keys(attendanceData).forEach(date => {
                            const record = attendanceData[date];
                            const isPresent = record.present && record.present.includes(parseInt(roll));
                            
                            if (isPresent) {
                                presentDays++;
                            } else {
                                absentDays++;
                                // Format date
                                const formattedDate = new Date(date).toLocaleDateString('en-GB', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                });
                                
                                // Get day name
                                const dayName = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });
                                
                                attendanceTableHTML += `
                                    <tr>
                                        <td>${formattedDate}</td>
                                        <td>${dayName}</td>
                                        <td class="absent">Absent</td>
                                    </tr>
                                `;
                            }
                        });
                    }
                    
                    // Update stats
                    const totalDays = presentDays + absentDays;
                    const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                    
                    presentStat.textContent = presentDays;
                    absentStat.textContent = absentDays;
                    attendancePercent.textContent = `${attendancePercentage}%`;
                    
                    // Update table
                    if (attendanceTableHTML === '') {
                        attendanceTableHTML = `<tr><td colspan="3">No absence records found</td></tr>`;
                    }
                    
                    studentAttendanceTable.innerHTML = attendanceTableHTML;
                    studentReportContent.style.display = 'block';
                    
                } catch (error) {
                    console.error("Error generating report:", error);
                    alert("Error generating student report");
                }
            });
        });
    </script>
</body>
</html>
